# Reth å¦‚ä½•ä»é›¶å¼€å§‹æ„å»ºä¸€ä¸ªå®Œæ•´çš„åŒºå—

## ğŸ“‹ **æ€»è§ˆï¼šä¸‰å¤§é˜¶æ®µ**

```
é˜¶æ®µ 1: å‡†å¤‡é˜¶æ®µï¼ˆPre-Executionï¼‰
é˜¶æ®µ 2: äº¤æ˜“æ‰§è¡Œé˜¶æ®µï¼ˆTransaction Executionï¼‰
é˜¶æ®µ 3: åŒºå—ç»„è£…é˜¶æ®µï¼ˆBlock Assemblyï¼‰
```

---

## ğŸ¬ **å®Œæ•´æµç¨‹å›¾**

```
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘                     ã€å¯åŠ¨ï¼šå…±è¯†å±‚å‘èµ·è¯·æ±‚ã€‘                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…±è¯†å±‚ï¼ˆBeacon Chainï¼‰                                                 â”‚
â”‚                                                                         â”‚
â”‚  HTTP POST /eth/v3/engine_forkchoiceUpdatedV3                         â”‚
â”‚  {                                                                     â”‚
â”‚    "forkchoiceState": {                                               â”‚
â”‚      "headBlockHash": "0xabc...",                                    â”‚
â”‚      "safeBlockHash": "0xdef...",                                    â”‚
â”‚      "finalizedBlockHash": "0x123..."                                â”‚
â”‚    },                                                                  â”‚
â”‚    "payloadAttributes": {                                             â”‚
â”‚      "timestamp": 1234567890,           // PRE å­—æ®µ                    â”‚
â”‚      "prevRandao": "0x456...",          // PRE å­—æ®µ                    â”‚
â”‚      "suggestedFeeRecipient": "0x789...", // PRE å­—æ®µ                 â”‚
â”‚      "withdrawals": [...],              // PRE å­—æ®µ                    â”‚
â”‚      "parentBeaconBlockRoot": "0xabc..."  // PRE å­—æ®µ                 â”‚
â”‚    }                                                                   â”‚
â”‚  }                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
                    ã€Engine API å±‚æ¥æ”¶è¯·æ±‚ã€‘
                                 â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ã€é˜¶æ®µ 1ï¼šå‡†å¤‡é˜¶æ®µ - Pre-Execution Setupã€‘                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1.1ï¼šéªŒè¯å¹¶è§£æ PayloadAttributes                                â”‚
â”‚  â”œâ”€ éªŒè¯ timestamp > parent.timestamp                                 â”‚
â”‚  â”œâ”€ éªŒè¯ withdrawals æ ¼å¼                                             â”‚
â”‚  â”œâ”€ ç”Ÿæˆ PayloadId = hash(attributes)                                â”‚
â”‚  â””â”€ ç«‹å³è¿”å›å“åº”ç»™å…±è¯†å±‚ âœ…                                            â”‚
â”‚     Response: { "payloadId": "0x1234...", "status": "VALID" }       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1.2ï¼šåˆå§‹åŒ–åŒºå—æ„å»ºå™¨ï¼ˆå¼‚æ­¥åå°ä»»åŠ¡ï¼‰                             â”‚
â”‚  â”œâ”€ è·å–çˆ¶åŒºå—çŠ¶æ€ï¼šstate_by_block_hash(parent_hash)                  â”‚
â”‚  â”œâ”€ åˆ›å»º StateProviderDatabase(state_provider)                       â”‚
â”‚  â””â”€ åˆå§‹åŒ– REVM Stateï¼š                                               â”‚
â”‚     State::builder()                                                  â”‚
â”‚       .with_database(state)                                          â”‚
â”‚       .with_bundle_update()  // å¯ç”¨çŠ¶æ€è¿½è¸ª                          â”‚
â”‚       .build()                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1.3ï¼šåˆ›å»º BlockBuilder                                           â”‚
â”‚  â”œâ”€ è®¾ç½® EVM ç¯å¢ƒï¼ˆä½¿ç”¨ PayloadAttributes ä¸­çš„ PRE å­—æ®µï¼‰             â”‚
â”‚  â”‚  â”œâ”€ block_env.number = parent.number + 1                          â”‚
â”‚  â”‚  â”œâ”€ block_env.timestamp = attributes.timestamp                    â”‚
â”‚  â”‚  â”œâ”€ block_env.beneficiary = attributes.suggestedFeeRecipient      â”‚
â”‚  â”‚  â”œâ”€ block_env.gas_limit = 30_000_000                             â”‚
â”‚  â”‚  â”œâ”€ block_env.basefee = calculate_next_base_fee(parent)          â”‚
â”‚  â”‚  â”œâ”€ block_env.prevrandao = attributes.prevRandao                  â”‚
â”‚  â”‚  â””â”€ block_env.blob_excess_gas = calculate_from_parent(parent)    â”‚
â”‚  â”‚                                                                    â”‚
â”‚  â””â”€ evm_config.builder_for_next_block(&mut db, &parent, env)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1.4ï¼šåº”ç”¨ Pre-Execution ç³»ç»Ÿè°ƒç”¨                                 â”‚
â”‚  builder.apply_pre_execution_changes() {                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚    â”‚  EIP-4788: Beacon Block Root Contract Call          â”‚            â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚            â”‚
â”‚    â”‚  if parent_beacon_block_root.is_some() {            â”‚            â”‚
â”‚    â”‚    // ç³»ç»Ÿè°ƒç”¨ï¼šSYSTEM_ADDRESS â†’ BEACON_ROOTS_ADDR  â”‚            â”‚
â”‚    â”‚    evm.transact({                                   â”‚            â”‚
â”‚    â”‚      caller: 0x000...00000 (SYSTEM_ADDRESS)         â”‚            â”‚
â”‚    â”‚      to: 0x000...04788 (BEACON_ROOTS_ADDRESS)       â”‚            â”‚
â”‚    â”‚      input: parent_beacon_block_root                â”‚            â”‚
â”‚    â”‚      gas_limit: 30_000_000                          â”‚            â”‚
â”‚    â”‚      gas_price: 0 // ç³»ç»Ÿè°ƒç”¨ä¸æ¶ˆè€— gas              â”‚            â”‚
â”‚    â”‚    })                                                â”‚            â”‚
â”‚    â”‚    // ç»“æœï¼šåœ¨ slot[timestamp % 8191] å†™å…¥ root      â”‚            â”‚
â”‚    â”‚  }                                                   â”‚            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚    â”‚  EIP-2935: Block Hash History Storage               â”‚            â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚            â”‚
â”‚    â”‚  // å­˜å‚¨æœ€è¿‘ 8192 ä¸ªåŒºå—å“ˆå¸Œ                         â”‚            â”‚
â”‚    â”‚  if block_number > 1 {                              â”‚            â”‚
â”‚    â”‚    evm.transact({                                   â”‚            â”‚
â”‚    â”‚      caller: SYSTEM_ADDRESS                         â”‚            â”‚
â”‚    â”‚      to: HISTORY_STORAGE_ADDRESS                    â”‚            â”‚
â”‚    â”‚      input: parent_hash                             â”‚            â”‚
â”‚    â”‚    })                                                â”‚            â”‚
â”‚    â”‚  }                                                   â”‚            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  }                                                                     â”‚
â”‚  âœ… Pre-Execution å®Œæˆ                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ã€é˜¶æ®µ 2ï¼šäº¤æ˜“æ‰§è¡Œé˜¶æ®µ - Transaction Executionã€‘              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2.1ï¼šä»äº¤æ˜“æ± è·å–æœ€ä½³äº¤æ˜“                                         â”‚
â”‚  let mut best_txs = pool.best_transactions_with_attributes({          â”‚
â”‚    base_fee: block_env.basefee,                                       â”‚
â”‚    blob_fee: block_env.blob_gasprice,                                â”‚
â”‚  });                                                                   â”‚
â”‚                                                                        â”‚
â”‚  äº¤æ˜“æ± æŒ‰ä¼˜å…ˆçº§æ’åºï¼š                                                   â”‚
â”‚  â”œâ”€ ä¼˜å…ˆçº§ = effective_gas_tip_per_gas                                â”‚
â”‚  â”œâ”€ è¿‡æ»¤æ‰ gas_price < base_fee çš„äº¤æ˜“                                â”‚
â”‚  â”œâ”€ è¿‡æ»¤æ‰ nonce ä¸è¿ç»­çš„äº¤æ˜“                                         â”‚
â”‚  â””â”€ è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼šbest_txs.next() â†’ Option<Transaction>            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2.2ï¼šåˆå§‹åŒ–æ‰§è¡Œè¿½è¸ªå˜é‡                                          â”‚
â”‚  let mut cumulative_gas_used = 0;                                     â”‚
â”‚  let mut total_fees = U256::ZERO;                                     â”‚
â”‚  let mut executed_txs = Vec::new();                                   â”‚
â”‚  let mut blob_sidecars = Vec::new();                                  â”‚
â”‚  let block_gas_limit = 30_000_000;                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2.3ï¼šå¾ªç¯æ‰§è¡Œäº¤æ˜“                                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  while let Some(pool_tx) = best_txs.next(()) {                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚  å­æ­¥éª¤ 2.3.1ï¼šé¢„æ£€æŸ¥                                        â”‚   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚    â”‚  // æ£€æŸ¥ gas é™åˆ¶                                           â”‚   â”‚
â”‚    â”‚  if cumulative_gas_used + pool_tx.gas_limit() > block_gas_limit {â”‚
â”‚    â”‚    break; // åŒºå—å·²æ»¡ï¼Œåœæ­¢æ·»åŠ äº¤æ˜“                         â”‚   â”‚
â”‚    â”‚  }                                                           â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚  // æ£€æŸ¥ blob gasï¼ˆEIP-4844ï¼‰                               â”‚   â”‚
â”‚    â”‚  if let Some(blob_tx) = pool_tx.as_eip4844() {             â”‚   â”‚
â”‚    â”‚    if cumulative_blob_gas + blob_tx.blob_gas() > max_blob_gas {â”‚
â”‚    â”‚      continue; // è·³è¿‡æ­¤äº¤æ˜“                                â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚  }                                                           â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚  å­æ­¥éª¤ 2.3.2ï¼šæ‰§è¡Œäº¤æ˜“ï¼ˆä¸æäº¤ï¼‰                            â”‚   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚    â”‚  let result = builder.execute_transaction_without_commit(tx) {  â”‚
â”‚    â”‚    // å†…éƒ¨è°ƒç”¨ REVM                                         â”‚   â”‚
â”‚    â”‚    let ResultAndState { result, state } = evm.transact(tx_env) {â”‚
â”‚    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚    â”‚      â”‚  REVM æ‰§è¡Œè¿‡ç¨‹                            â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  1. éªŒè¯ nonce                           â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  2. æ‰£é™¤ gas é¢„ä»˜æ¬¾                       â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  3. æ‰§è¡Œ EVM å­—èŠ‚ç                        â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  4. æ”¶é›† logsï¼ˆemit eventï¼‰               â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  5. è¿”è¿˜æœªä½¿ç”¨çš„ gas                      â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  6. æ”¯ä»˜çŸ¿å·¥è´¹ç”¨                          â”‚           â”‚   â”‚
â”‚    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚    return ResultAndState {                                  â”‚   â”‚
â”‚    â”‚      result: ExecutionResult {                              â”‚   â”‚
â”‚    â”‚        reason: Success/Revert/Halt,                         â”‚   â”‚
â”‚    â”‚        gas_used: u64,                                       â”‚   â”‚
â”‚    â”‚        gas_refunded: u64,                                   â”‚   â”‚
â”‚    â”‚        logs: Vec<Log>,                                      â”‚   â”‚
â”‚    â”‚        output: Bytes,                                       â”‚   â”‚
â”‚    â”‚      },                                                      â”‚   â”‚
â”‚    â”‚      state: HashMap<Address, AccountState>  // çŠ¶æ€å˜æ›´     â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚  }?;                                                         â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚  å­æ­¥éª¤ 2.3.3ï¼šå¤„ç†æ‰§è¡Œç»“æœ                                  â”‚   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚    â”‚  match result.result {                                      â”‚   â”‚
â”‚    â”‚    ExecutionResult::Success { gas_used, logs, .. } => {     â”‚   â”‚
â”‚    â”‚      âœ… äº¤æ˜“æˆåŠŸ                                             â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚    ExecutionResult::Revert { .. } => {                      â”‚   â”‚
â”‚    â”‚      âš ï¸  äº¤æ˜“å¤±è´¥ï¼ˆrevertï¼‰ï¼Œä½†ä»æ¶ˆè€— gas                    â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚    ExecutionResult::Halt { reason, .. } => {                â”‚   â”‚
â”‚    â”‚      âŒ è‡´å‘½é”™è¯¯                                             â”‚   â”‚
â”‚    â”‚      match reason {                                          â”‚   â”‚
â”‚    â”‚        InvalidTransaction => {                               â”‚   â”‚
â”‚    â”‚          // æ ‡è®°æ­¤å‘é€è€…çš„æ‰€æœ‰åç»­äº¤æ˜“ä¸ºæ— æ•ˆ                 â”‚   â”‚
â”‚    â”‚          best_txs.mark_invalid(tx.sender(), tx.nonce());    â”‚   â”‚
â”‚    â”‚          continue; // è·³è¿‡æ­¤äº¤æ˜“ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª                â”‚   â”‚
â”‚    â”‚        }                                                     â”‚   â”‚
â”‚    â”‚        OutOfGas | ... => {                                  â”‚   â”‚
â”‚    â”‚          continue; // è·³è¿‡æ­¤äº¤æ˜“                            â”‚   â”‚
â”‚    â”‚        }                                                     â”‚   â”‚
â”‚    â”‚      }                                                       â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚  }                                                           â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚  å­æ­¥éª¤ 2.3.4ï¼šæäº¤äº¤æ˜“çŠ¶æ€                                  â”‚   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚    â”‚  let gas_used = builder.commit_transaction(result, tx) {    â”‚   â”‚
â”‚    â”‚    // åˆå¹¶çŠ¶æ€å˜æ›´åˆ° bundle_state                           â”‚   â”‚
â”‚    â”‚    db.commit(result.state);                                 â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚    // ç”Ÿæˆ Receipt                                          â”‚   â”‚
â”‚    â”‚    let receipt = Receipt {                                  â”‚   â”‚
â”‚    â”‚      success: result.is_success(),                          â”‚   â”‚
â”‚    â”‚      cumulative_gas_used: cumulative_gas_used + gas_used,  â”‚   â”‚
â”‚    â”‚      logs: result.logs,                                     â”‚   â”‚
â”‚    â”‚      logs_bloom: calculate_bloom(result.logs),              â”‚   â”‚
â”‚    â”‚    };                                                        â”‚   â”‚
â”‚    â”‚    receipts.push(receipt);                                  â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚    return gas_used;                                         â”‚   â”‚
â”‚    â”‚  };                                                          â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚  å­æ­¥éª¤ 2.3.5ï¼šæ›´æ–°ç´¯ç§¯å€¼                                    â”‚   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚    â”‚  cumulative_gas_used += gas_used;                           â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚  // è®¡ç®—çŸ¿å·¥è´¹ç”¨                                            â”‚   â”‚
â”‚    â”‚  let miner_fee = tx.effective_tip_per_gas(base_fee);       â”‚   â”‚
â”‚    â”‚  total_fees += miner_fee * gas_used;                        â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚  // ä¿å­˜äº¤æ˜“                                                â”‚   â”‚
â”‚    â”‚  executed_txs.push(tx);                                     â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚  // å¦‚æœæ˜¯ blob äº¤æ˜“ï¼Œä¿å­˜ sidecar                          â”‚   â”‚
â”‚    â”‚  if let Some(sidecar) = tx.blob_sidecar() {                â”‚   â”‚
â”‚    â”‚    blob_sidecars.push(sidecar);                             â”‚   â”‚
â”‚    â”‚  }                                                           â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  }  // â† end while loop                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  âœ… æ‰€æœ‰äº¤æ˜“æ‰§è¡Œå®Œæˆ                                                   â”‚
â”‚                                                                        â”‚
â”‚  æœ€ç»ˆçŠ¶æ€ï¼š                                                            â”‚
â”‚  â”œâ”€ cumulative_gas_used = 15_234_567                                 â”‚
â”‚  â”œâ”€ total_fees = 0.123 ETH                                           â”‚
â”‚  â”œâ”€ executed_txs = [tx1, tx2, ..., tx_n]                            â”‚
â”‚  â”œâ”€ receipts = [receipt1, receipt2, ..., receipt_n]                 â”‚
â”‚  â””â”€ blob_sidecars = [sidecar1, sidecar2, ...]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2.4ï¼šå¤„ç† Withdrawalsï¼ˆææ¬¾ï¼‰                                    â”‚
â”‚  if let Some(withdrawals) = attributes.withdrawals {                  â”‚
â”‚    for withdrawal in withdrawals {                                    â”‚
â”‚      // ç›´æ¥å¢åŠ è´¦æˆ·ä½™é¢ï¼ˆä¸é€šè¿‡äº¤æ˜“ï¼‰                                â”‚
â”‚      let account = db.get_account(withdrawal.address)?;              â”‚
â”‚      account.balance += withdrawal.amount;                            â”‚
â”‚      db.update_account(withdrawal.address, account);                 â”‚
â”‚    }                                                                   â”‚
â”‚  }                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ã€é˜¶æ®µ 3ï¼šåŒºå—ç»„è£…é˜¶æ®µ - Block Assembly & Post-Executionã€‘     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.1ï¼šå®ŒæˆåŒºå—æ„å»ºå¹¶è·å– BundleState                               â”‚
â”‚  let BlockBuilderOutcome {                                            â”‚
â”‚    execution_result,  // åŒ…å« receipts, gas_used, requests            â”‚
â”‚    block,             // åŒ…å« recovered_block, hashed_state, trie_updatesâ”‚
â”‚    ..                                                                  â”‚
â”‚  } = builder.finish(state_provider)?;                                 â”‚
â”‚                                                                        â”‚
â”‚  // ä» REVM State ä¸­æå–æœ€ç»ˆçŠ¶æ€                                       â”‚
â”‚  let bundle_state = db.take_bundle();                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.2ï¼šè®¡ç®— POST-EXECUTION å­—æ®µ                                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.1 è®¡ç®— state_root                                           â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  // ä» bundle_state ç”Ÿæˆ HashedPostState                        â”‚ â”‚
â”‚  â”‚  let hashed_state = HashedPostState::from_bundle_state(         â”‚ â”‚
â”‚  â”‚    bundle_state.state()                                         â”‚ â”‚
â”‚  â”‚  );                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  // è®¡ç®— Merkle Patricia Trie æ ¹                                â”‚ â”‚
â”‚  â”‚  let (state_root, trie_updates) =                               â”‚ â”‚
â”‚  â”‚    state_provider.state_root_with_updates(hashed_state)?;      â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  // å†…éƒ¨æµç¨‹ï¼š                                                   â”‚ â”‚
â”‚  â”‚  // 1. éå† hashed_state ä¸­çš„æ‰€æœ‰è´¦æˆ·å˜æ›´                       â”‚ â”‚
â”‚  â”‚  // 2. å¯¹æ¯ä¸ªè´¦æˆ·ï¼Œè®¡ç®—å…¶ storage_root                          â”‚ â”‚
â”‚  â”‚  // 3. æ„å»º TrieAccount { nonce, balance, storage_root, code_hash }â”‚
â”‚  â”‚  // 4. å°†æ‰€æœ‰ TrieAccount æ’å…¥ Account Trie                     â”‚ â”‚
â”‚  â”‚  // 5. è®¡ç®— Account Trie çš„æ ¹å“ˆå¸Œ â†’ state_root                  â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  âœ… state_root = 0x1234abcd...                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.2 è®¡ç®— transactions_root                                    â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  let transactions_root = calculate_transaction_root(             â”‚ â”‚
â”‚  â”‚    &executed_txs                                                 â”‚ â”‚
â”‚  â”‚  );                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  // å†…éƒ¨ï¼šå¯¹æ‰€æœ‰äº¤æ˜“è®¡ç®— Merkle Patricia Trie                    â”‚ â”‚
â”‚  â”‚  // Input: [tx1, tx2, ..., tx_n]                                â”‚ â”‚
â”‚  â”‚  // Output: Root hash of transaction trie                       â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  âœ… transactions_root = 0x5678ef01...                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.3 è®¡ç®— receipts_root                                        â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  let receipts_root = calculate_receipt_root(                    â”‚ â”‚
â”‚  â”‚    &receipts.iter().map(|r| r.with_bloom_ref()).collect()      â”‚ â”‚
â”‚  â”‚  );                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  // å¯¹æ‰€æœ‰ receipts è®¡ç®— Merkle Patricia Trie                   â”‚ â”‚
â”‚  â”‚  âœ… receipts_root = 0x9abcdef2...                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.4 è®¡ç®— logs_bloom                                           â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  let logs_bloom = logs_bloom(                                   â”‚ â”‚
â”‚  â”‚    receipts.iter().flat_map(|r| r.logs())                      â”‚ â”‚
â”‚  â”‚  );                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  // èšåˆæ‰€æœ‰äº¤æ˜“çš„ logsï¼Œç”Ÿæˆ Bloom filter                       â”‚ â”‚
â”‚  â”‚  // ç”¨äºå¿«é€Ÿæ£€ç´¢åŒ…å«ç‰¹å®š event çš„åŒºå—                           â”‚ â”‚
â”‚  â”‚  âœ… logs_bloom = Bloom([0xff, 0x3a, ...])                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.5 è®¡ç®— withdrawals_root                                     â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  let withdrawals_root = attributes.withdrawals.as_ref().map(    â”‚ â”‚
â”‚  â”‚    |w| calculate_withdrawals_root(w)                            â”‚ â”‚
â”‚  â”‚  );                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  âœ… withdrawals_root = Some(0xabcd1234...)                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.6 è®¡ç®— requests_hash (Prague åˆ†å‰å)                        â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  let requests_hash = if is_prague_active {                      â”‚ â”‚
â”‚  â”‚    Some(execution_result.requests.requests_hash())              â”‚ â”‚
â”‚  â”‚  } else {                                                        â”‚ â”‚
â”‚  â”‚    None                                                          â”‚ â”‚
â”‚  â”‚  };                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  âœ… requests_hash = Some(0x4567cdef...)                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.7 å…¶ä»– POST å­—æ®µ                                            â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  âœ… gas_used = cumulative_gas_used  (15_234_567)                â”‚ â”‚
â”‚  â”‚  âœ… blob_gas_used = cumulative_blob_gas                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.3ï¼šç»„è£…å®Œæ•´åŒºå—å¤´                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  let header = Header {                                                â”‚
â”‚    // ============== PRE-EXECUTION å­—æ®µ ==============               â”‚
â”‚    parent_hash: parent_header.hash(),                                â”‚
â”‚    number: parent_header.number + 1,                                 â”‚
â”‚    timestamp: attributes.timestamp,                                  â”‚
â”‚    beneficiary: attributes.suggested_fee_recipient,                  â”‚
â”‚    gas_limit: 30_000_000,                                            â”‚
â”‚    base_fee_per_gas: Some(calculated_base_fee),                     â”‚
â”‚    difficulty: U256::ZERO,  // PoS åå›ºå®šä¸º 0                        â”‚
â”‚    mix_hash: attributes.prev_randao,                                 â”‚
â”‚    nonce: BEACON_NONCE,  // PoS åå›ºå®šä¸º 0                           â”‚
â”‚    ommers_hash: EMPTY_OMMER_ROOT_HASH,  // PoS åå›ºå®šä¸ºç©º            â”‚
â”‚    extra_data: builder_config.extra_data,                           â”‚
â”‚    parent_beacon_block_root: attributes.parent_beacon_block_root,   â”‚
â”‚    excess_blob_gas: calculate_from_parent(parent),                  â”‚
â”‚                                                                       â”‚
â”‚    // ============== POST-EXECUTION å­—æ®µ ==============              â”‚
â”‚    state_root,              // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    transactions_root,       // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    receipts_root,           // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    logs_bloom,              // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    gas_used,                // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    blob_gas_used,           // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    withdrawals_root,        // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    requests_hash,           // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚  };                                                                   â”‚
â”‚                                                                       â”‚
â”‚  âœ… å®Œæ•´åŒºå—å¤´æ„å»ºå®Œæˆï¼                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.4ï¼šè®¡ç®—åŒºå—å“ˆå¸Œ                                                â”‚
â”‚  let block_hash = keccak256(rlp_encode(header));                     â”‚
â”‚  âœ… block_hash = 0xabcd1234ef567890...                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.5ï¼šåˆ›å»º SealedBlock                                            â”‚
â”‚  let sealed_block = SealedBlock {                                     â”‚
â”‚    header: SealedHeader { hash: block_hash, header },                â”‚
â”‚    body: BlockBody {                                                  â”‚
â”‚      transactions: executed_txs,                                     â”‚
â”‚      ommers: vec![],                                                 â”‚
â”‚      withdrawals: attributes.withdrawals,                            â”‚
â”‚    },                                                                 â”‚
â”‚  };                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.6ï¼šæ„å»º EthBuiltPayload                                        â”‚
â”‚  let payload = EthBuiltPayload {                                      â”‚
â”‚    id: payload_id,                                                    â”‚
â”‚    block: Arc::new(sealed_block),                                    â”‚
â”‚    fees: total_fees,                                                 â”‚
â”‚    sidecars: blob_sidecars,                                          â”‚
â”‚    requests: execution_result.requests,                              â”‚
â”‚  };                                                                    â”‚
â”‚                                                                        â”‚
â”‚  // å­˜å‚¨åˆ°å†…å­˜ç¼“å­˜                                                     â”‚
â”‚  payload_store.put(payload_id, payload.clone());                     â”‚
â”‚  âœ… Payload æ„å»ºå®Œæˆå¹¶ç¼“å­˜                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  ã€å®Œæˆï¼šè¿”å›ç»™å…±è¯†å±‚ã€‘                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…±è¯†å±‚ç¨åè°ƒç”¨ï¼šengine_getPayloadV3(payload_id)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰§è¡Œå±‚è¿”å›å®Œæ•´ ExecutionPayloadï¼š                                     â”‚
â”‚  {                                                                     â”‚
â”‚    "blockNumber": 12345678,                                          â”‚
â”‚    "blockHash": "0xabcd1234ef567890...",                             â”‚
â”‚    "parentHash": "0x1234...",                                        â”‚
â”‚    "timestamp": 1234567890,                                          â”‚
â”‚    "feeRecipient": "0x789...",                                       â”‚
â”‚    "gasLimit": 30000000,                                             â”‚
â”‚    "gasUsed": 15234567,                      // â† POST               â”‚
â”‚    "stateRoot": "0x1234abcd...",             // â† POST               â”‚
â”‚    "receiptsRoot": "0x9abcdef2...",          // â† POST               â”‚
â”‚    "logsBloom": "0xff3a...",                 // â† POST               â”‚
â”‚    "transactionsRoot": "0x5678ef01...",      // â† POST               â”‚
â”‚    "transactions": [...],                                            â”‚
â”‚    "withdrawals": [...],                                             â”‚
â”‚    "blobGasUsed": 262144,                    // â† POST               â”‚
â”‚    "excessBlobGas": 0,                                               â”‚
â”‚    "parentBeaconBlockRoot": "0xabc...",                              â”‚
â”‚    "requestsHash": "0x4567cdef..."           // â† POST               â”‚
â”‚  }                                                                     â”‚
â”‚  âœ… å…±è¯†å±‚æ”¶åˆ°å®Œæ•´ Payload å¹¶å¹¿æ’­ç»™ç½‘ç»œ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **å…³é”®å­—æ®µå¡«å……æ—¶é—´è¡¨**

| å­—æ®µ | ç±»å‹ | ä½•æ—¶å¡«å…… | æ•°æ®æ¥æº |
|------|------|----------|----------|
| `parent_hash` | PRE | æ­¥éª¤ 1.3 | PayloadAttributes / çˆ¶åŒºå— |
| `number` | PRE | æ­¥éª¤ 1.3 | parent.number + 1 |
| `timestamp` | PRE | æ­¥éª¤ 1.3 | PayloadAttributes |
| `beneficiary` | PRE | æ­¥éª¤ 1.3 | PayloadAttributes.suggestedFeeRecipient |
| `gas_limit` | PRE | æ­¥éª¤ 1.3 | é…ç½® / çˆ¶åŒºå— |
| `base_fee_per_gas` | PRE | æ­¥éª¤ 1.3 | åŸºäºçˆ¶åŒºå—è®¡ç®— |
| `prevrandao` | PRE | æ­¥éª¤ 1.3 | PayloadAttributes |
| `parent_beacon_block_root` | PRE | æ­¥éª¤ 1.3 | PayloadAttributes |
| `excess_blob_gas` | PRE | æ­¥éª¤ 1.3 | åŸºäºçˆ¶åŒºå—è®¡ç®— |
| **`gas_used`** | **POST** | **æ­¥éª¤ 2.3.5** | **ç´¯ç§¯æ‰€æœ‰äº¤æ˜“çš„ gas** |
| **`state_root`** | **POST** | **æ­¥éª¤ 3.2.1** | **ä» bundle_state è®¡ç®— Trie æ ¹** |
| **`transactions_root`** | **POST** | **æ­¥éª¤ 3.2.2** | **äº¤æ˜“åˆ—è¡¨çš„ Merkle æ ¹** |
| **`receipts_root`** | **POST** | **æ­¥éª¤ 3.2.3** | **Receipts çš„ Merkle æ ¹** |
| **`logs_bloom`** | **POST** | **æ­¥éª¤ 3.2.4** | **èšåˆæ‰€æœ‰ logs çš„ Bloom filter** |
| **`blob_gas_used`** | **POST** | **æ­¥éª¤ 2.3.5** | **ç´¯ç§¯æ‰€æœ‰ blob äº¤æ˜“çš„ gas** |
| **`withdrawals_root`** | **POST** | **æ­¥éª¤ 3.2.5** | **Withdrawals çš„ Merkle æ ¹** |
| **`requests_hash`** | **POST** | **æ­¥éª¤ 3.2.6** | **ç³»ç»Ÿè¯·æ±‚çš„å“ˆå¸Œ** |
| **`block_hash`** | **POST** | **æ­¥éª¤ 3.4** | **keccak256(rlp_encode(header))** |

---

## ğŸ¯ **æ ¸å¿ƒè¦ç‚¹æ€»ç»“**

1. **Pre-Execution ç³»ç»Ÿè°ƒç”¨**ï¼ˆæ­¥éª¤ 1.4ï¼‰åœ¨ç”¨æˆ·äº¤æ˜“ä¹‹å‰æ‰§è¡Œ
2. **äº¤æ˜“å¾ªç¯**ï¼ˆæ­¥éª¤ 2.3ï¼‰é€ä¸ªæ‰§è¡Œï¼Œç´¯ç§¯çŠ¶æ€å’Œ gas
3. **Post-Execution å­—æ®µ**ï¼ˆæ­¥éª¤ 3.2ï¼‰åœ¨æ‰€æœ‰äº¤æ˜“æ‰§è¡Œå®Œæˆåè®¡ç®—
4. **æœ€ç»ˆåŒºå—å¤´**ï¼ˆæ­¥éª¤ 3.3ï¼‰åŒ…å«æ‰€æœ‰ PRE å’Œ POST å­—æ®µ
5. **å®Œæ•´ ExecutionPayload** è¿”å›ç»™å…±è¯†å±‚ç”¨äºå¹¿æ’­

è¿™å°±æ˜¯ Reth æ„å»ºåŒºå—çš„å®Œæ•´ã€è¯¦ç»†æµç¨‹ï¼ğŸš€