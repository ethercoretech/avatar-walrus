# Reth å¦‚ä½•ä»é›¶å¼€å§‹æ„å»ºä¸€ä¸ªå®Œæ•´çš„åŒºå—

## ğŸ“‹ **æ€»è§ˆï¼šä¸‰å¤§é˜¶æ®µ**

```
é˜¶æ®µ 1: å‡†å¤‡é˜¶æ®µï¼ˆPre-Executionï¼‰
é˜¶æ®µ 2: äº¤æ˜“æ‰§è¡Œé˜¶æ®µï¼ˆTransaction Executionï¼‰
é˜¶æ®µ 3: åŒºå—ç»„è£…é˜¶æ®µï¼ˆBlock Assemblyï¼‰
```

---

## ğŸ¬ **å®Œæ•´æµç¨‹å›¾**

```
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â•‘                     ã€å¯åŠ¨ï¼šå…±è¯†å±‚å‘èµ·è¯·æ±‚ã€‘                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…±è¯†å±‚ï¼ˆBeacon Chainï¼‰                                                 â”‚
â”‚                                                                         â”‚
â”‚  HTTP POST /eth/v3/engine_forkchoiceUpdatedV3                         â”‚
â”‚  {                                                                     â”‚
â”‚    "forkchoiceState": {                                               â”‚
â”‚      "headBlockHash": "0xabc...",                                    â”‚
â”‚      "safeBlockHash": "0xdef...",                                    â”‚
â”‚      "finalizedBlockHash": "0x123..."                                â”‚
â”‚    },                                                                  â”‚
â”‚    "payloadAttributes": {                                             â”‚
â”‚      "timestamp": 1234567890,           // PRE å­—æ®µ                    â”‚
â”‚      "prevRandao": "0x456...",          // PRE å­—æ®µ                    â”‚
â”‚      "suggestedFeeRecipient": "0x789...", // PRE å­—æ®µ                 â”‚
â”‚      "withdrawals": [...],              // PRE å­—æ®µ                    â”‚
â”‚      "parentBeaconBlockRoot": "0xabc..."  // PRE å­—æ®µ                 â”‚
â”‚    }                                                                   â”‚
â”‚  }                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
                    ã€Engine API å±‚æ¥æ”¶è¯·æ±‚ã€‘
                                 â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ã€é˜¶æ®µ 1ï¼šå‡†å¤‡é˜¶æ®µ - Pre-Execution Setupã€‘                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1.1ï¼šéªŒè¯å¹¶è§£æ PayloadAttributes                                â”‚
â”‚  â”œâ”€ éªŒè¯ timestamp > parent.timestamp                                 â”‚
â”‚  â”œâ”€ éªŒè¯ withdrawals æ ¼å¼                                             â”‚
â”‚  â”œâ”€ ç”Ÿæˆ PayloadId = hash(attributes)                                â”‚
â”‚  â””â”€ ç«‹å³è¿”å›å“åº”ç»™å…±è¯†å±‚ âœ…                                            â”‚
â”‚     Response: { "payloadId": "0x1234...", "status": "VALID" }       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1.2ï¼šåˆå§‹åŒ–åŒºå—æ„å»ºå™¨ï¼ˆå¼‚æ­¥åå°ä»»åŠ¡ï¼‰                             â”‚
â”‚  â”œâ”€ è·å–çˆ¶åŒºå—çŠ¶æ€ï¼šstate_by_block_hash(parent_hash)                  â”‚
â”‚  â”œâ”€ åˆ›å»º StateProviderDatabase(state_provider)                       â”‚
â”‚  â””â”€ åˆå§‹åŒ– REVM Stateï¼š                                               â”‚
â”‚     State::builder()                                                  â”‚
â”‚       .with_database(state)                                          â”‚
â”‚       .with_bundle_update()  // å¯ç”¨çŠ¶æ€è¿½è¸ª                          â”‚
â”‚       .build()                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1.3ï¼šåˆ›å»º BlockBuilder                                           â”‚
â”‚  â”œâ”€ è®¾ç½® EVM ç¯å¢ƒï¼ˆä½¿ç”¨ PayloadAttributes ä¸­çš„ PRE å­—æ®µï¼‰             â”‚
â”‚  â”‚  â”œâ”€ block_env.number = parent.number + 1                          â”‚
â”‚  â”‚  â”œâ”€ block_env.timestamp = attributes.timestamp                    â”‚
â”‚  â”‚  â”œâ”€ block_env.beneficiary = attributes.suggestedFeeRecipient      â”‚
â”‚  â”‚  â”œâ”€ block_env.gas_limit = 30_000_000                             â”‚
â”‚  â”‚  â”œâ”€ block_env.basefee = calculate_next_base_fee(parent)          â”‚
â”‚  â”‚  â”œâ”€ block_env.prevrandao = attributes.prevRandao                  â”‚
â”‚  â”‚  â””â”€ block_env.blob_excess_gas = calculate_from_parent(parent)    â”‚
â”‚  â”‚                                                                    â”‚
â”‚  â””â”€ evm_config.builder_for_next_block(&mut db, &parent, env)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 1.4ï¼šåº”ç”¨ Pre-Execution ç³»ç»Ÿè°ƒç”¨                                 â”‚
â”‚  builder.apply_pre_execution_changes() {                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚    â”‚  EIP-4788: Beacon Block Root Contract Call          â”‚            â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚            â”‚
â”‚    â”‚  if parent_beacon_block_root.is_some() {            â”‚            â”‚
â”‚    â”‚    // ç³»ç»Ÿè°ƒç”¨ï¼šSYSTEM_ADDRESS â†’ BEACON_ROOTS_ADDR  â”‚            â”‚
â”‚    â”‚    evm.transact({                                   â”‚            â”‚
â”‚    â”‚      caller: 0x000...00000 (SYSTEM_ADDRESS)         â”‚            â”‚
â”‚    â”‚      to: 0x000...04788 (BEACON_ROOTS_ADDRESS)       â”‚            â”‚
â”‚    â”‚      input: parent_beacon_block_root                â”‚            â”‚
â”‚    â”‚      gas_limit: 30_000_000                          â”‚            â”‚
â”‚    â”‚      gas_price: 0 // ç³»ç»Ÿè°ƒç”¨ä¸æ¶ˆè€— gas              â”‚            â”‚
â”‚    â”‚    })                                                â”‚            â”‚
â”‚    â”‚    // ç»“æœï¼šåœ¨ slot[timestamp % 8191] å†™å…¥ root      â”‚            â”‚
â”‚    â”‚  }                                                   â”‚            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚    â”‚  EIP-2935: Block Hash History Storage               â”‚            â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚            â”‚
â”‚    â”‚  // å­˜å‚¨æœ€è¿‘ 8192 ä¸ªåŒºå—å“ˆå¸Œ                         â”‚            â”‚
â”‚    â”‚  if block_number > 1 {                              â”‚            â”‚
â”‚    â”‚    evm.transact({                                   â”‚            â”‚
â”‚    â”‚      caller: SYSTEM_ADDRESS                         â”‚            â”‚
â”‚    â”‚      to: HISTORY_STORAGE_ADDRESS                    â”‚            â”‚
â”‚    â”‚      input: parent_hash                             â”‚            â”‚
â”‚    â”‚    })                                                â”‚            â”‚
â”‚    â”‚  }                                                   â”‚            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  }                                                                     â”‚
â”‚  âœ… Pre-Execution å®Œæˆ                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ã€é˜¶æ®µ 2ï¼šäº¤æ˜“æ‰§è¡Œé˜¶æ®µ - Transaction Executionã€‘              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2.1ï¼šä»äº¤æ˜“æ± è·å–æœ€ä½³äº¤æ˜“                                         â”‚
â”‚  let mut best_txs = pool.best_transactions_with_attributes({          â”‚
â”‚    base_fee: block_env.basefee,                                       â”‚
â”‚    blob_fee: block_env.blob_gasprice,                                â”‚
â”‚  });                                                                   â”‚
â”‚                                                                        â”‚
â”‚  äº¤æ˜“æ± æŒ‰ä¼˜å…ˆçº§æ’åºï¼š                                                   â”‚
â”‚  â”œâ”€ ä¼˜å…ˆçº§ = effective_gas_tip_per_gas                                â”‚
â”‚  â”œâ”€ è¿‡æ»¤æ‰ gas_price < base_fee çš„äº¤æ˜“                                â”‚
â”‚  â”œâ”€ è¿‡æ»¤æ‰ nonce ä¸è¿ç»­çš„äº¤æ˜“                                         â”‚
â”‚  â””â”€ è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼šbest_txs.next() â†’ Option<Transaction>            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2.2ï¼šåˆå§‹åŒ–æ‰§è¡Œè¿½è¸ªå˜é‡                                          â”‚
â”‚  let mut cumulative_gas_used = 0;                                     â”‚
â”‚  let mut total_fees = U256::ZERO;                                     â”‚
â”‚  let mut executed_txs = Vec::new();                                   â”‚
â”‚  let mut blob_sidecars = Vec::new();                                  â”‚
â”‚  let block_gas_limit = 30_000_000;                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2.3ï¼šå¾ªç¯æ‰§è¡Œäº¤æ˜“                                                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  while let Some(pool_tx) = best_txs.next(()) {                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚  å­æ­¥éª¤ 2.3.1ï¼šé¢„æ£€æŸ¥                                        â”‚   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚    â”‚  // æ£€æŸ¥ gas é™åˆ¶                                           â”‚   â”‚
â”‚    â”‚  if cumulative_gas_used + pool_tx.gas_limit() > block_gas_limit {â”‚
â”‚    â”‚    break; // åŒºå—å·²æ»¡ï¼Œåœæ­¢æ·»åŠ äº¤æ˜“                         â”‚   â”‚
â”‚    â”‚  }                                                           â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚  // æ£€æŸ¥ blob gasï¼ˆEIP-4844ï¼‰                               â”‚   â”‚
â”‚    â”‚  if let Some(blob_tx) = pool_tx.as_eip4844() {             â”‚   â”‚
â”‚    â”‚    if cumulative_blob_gas + blob_tx.blob_gas() > max_blob_gas {â”‚
â”‚    â”‚      continue; // è·³è¿‡æ­¤äº¤æ˜“                                â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚  }                                                           â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚  å­æ­¥éª¤ 2.3.2ï¼šæ‰§è¡Œäº¤æ˜“ï¼ˆä¸æäº¤ï¼‰                            â”‚   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚    â”‚  let result = builder.execute_transaction_without_commit(tx) {  â”‚
â”‚    â”‚    // å†…éƒ¨è°ƒç”¨ REVM                                         â”‚   â”‚
â”‚    â”‚    let ResultAndState { result, state } = evm.transact(tx_env) {â”‚
â”‚    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚    â”‚      â”‚  REVM æ‰§è¡Œè¿‡ç¨‹                            â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  1. éªŒè¯ nonce                           â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  2. æ‰£é™¤ gas é¢„ä»˜æ¬¾                       â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  3. æ‰§è¡Œ EVM å­—èŠ‚ç                        â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  4. æ”¶é›† logsï¼ˆemit eventï¼‰               â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  5. è¿”è¿˜æœªä½¿ç”¨çš„ gas                      â”‚           â”‚   â”‚
â”‚    â”‚      â”‚  6. æ”¯ä»˜çŸ¿å·¥è´¹ç”¨                          â”‚           â”‚   â”‚
â”‚    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚    return ResultAndState {                                  â”‚   â”‚
â”‚    â”‚      result: ExecutionResult {                              â”‚   â”‚
â”‚    â”‚        reason: Success/Revert/Halt,                         â”‚   â”‚
â”‚    â”‚        gas_used: u64,                                       â”‚   â”‚
â”‚    â”‚        gas_refunded: u64,                                   â”‚   â”‚
â”‚    â”‚        logs: Vec<Log>,                                      â”‚   â”‚
â”‚    â”‚        output: Bytes,                                       â”‚   â”‚
â”‚    â”‚      },                                                      â”‚   â”‚
â”‚    â”‚      state: HashMap<Address, AccountState>  // çŠ¶æ€å˜æ›´     â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚  }?;                                                         â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚  å­æ­¥éª¤ 2.3.3ï¼šå¤„ç†æ‰§è¡Œç»“æœ                                  â”‚   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚    â”‚  match result.result {                                      â”‚   â”‚
â”‚    â”‚    ExecutionResult::Success { gas_used, logs, .. } => {     â”‚   â”‚
â”‚    â”‚      âœ… äº¤æ˜“æˆåŠŸ                                             â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚    ExecutionResult::Revert { .. } => {                      â”‚   â”‚
â”‚    â”‚      âš ï¸  äº¤æ˜“å¤±è´¥ï¼ˆrevertï¼‰ï¼Œä½†ä»æ¶ˆè€— gas                    â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚    ExecutionResult::Halt { reason, .. } => {                â”‚   â”‚
â”‚    â”‚      âŒ è‡´å‘½é”™è¯¯                                             â”‚   â”‚
â”‚    â”‚      match reason {                                          â”‚   â”‚
â”‚    â”‚        InvalidTransaction => {                               â”‚   â”‚
â”‚    â”‚          // æ ‡è®°æ­¤å‘é€è€…çš„æ‰€æœ‰åç»­äº¤æ˜“ä¸ºæ— æ•ˆ                 â”‚   â”‚
â”‚    â”‚          best_txs.mark_invalid(tx.sender(), tx.nonce());    â”‚   â”‚
â”‚    â”‚          continue; // è·³è¿‡æ­¤äº¤æ˜“ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª                â”‚   â”‚
â”‚    â”‚        }                                                     â”‚   â”‚
â”‚    â”‚        OutOfGas | ... => {                                  â”‚   â”‚
â”‚    â”‚          continue; // è·³è¿‡æ­¤äº¤æ˜“                            â”‚   â”‚
â”‚    â”‚        }                                                     â”‚   â”‚
â”‚    â”‚      }                                                       â”‚   â”‚
â”‚    â”‚    }                                                         â”‚   â”‚
â”‚    â”‚  }                                                           â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚  å­æ­¥éª¤ 2.3.4ï¼šæäº¤äº¤æ˜“çŠ¶æ€                                  â”‚   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚    â”‚  let gas_used = builder.commit_transaction(result, tx) {    â”‚   â”‚
â”‚    â”‚    // åˆå¹¶çŠ¶æ€å˜æ›´åˆ° bundle_state                           â”‚   â”‚
â”‚    â”‚    db.commit(result.state);                                 â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚    // ç”Ÿæˆ Receipt                                          â”‚   â”‚
â”‚    â”‚    let receipt = Receipt {                                  â”‚   â”‚
â”‚    â”‚      success: result.is_success(),                          â”‚   â”‚
â”‚    â”‚      cumulative_gas_used: cumulative_gas_used + gas_used,  â”‚   â”‚
â”‚    â”‚      logs: result.logs,                                     â”‚   â”‚
â”‚    â”‚      logs_bloom: calculate_bloom(result.logs),              â”‚   â”‚
â”‚    â”‚    };                                                        â”‚   â”‚
â”‚    â”‚    receipts.push(receipt);                                  â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚    return gas_used;                                         â”‚   â”‚
â”‚    â”‚  };                                                          â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â†“                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚  å­æ­¥éª¤ 2.3.5ï¼šæ›´æ–°ç´¯ç§¯å€¼                                    â”‚   â”‚
â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚    â”‚  cumulative_gas_used += gas_used;                           â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚  // è®¡ç®—çŸ¿å·¥è´¹ç”¨                                            â”‚   â”‚
â”‚    â”‚  let miner_fee = tx.effective_tip_per_gas(base_fee);       â”‚   â”‚
â”‚    â”‚  total_fees += miner_fee * gas_used;                        â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚  // ä¿å­˜äº¤æ˜“                                                â”‚   â”‚
â”‚    â”‚  executed_txs.push(tx);                                     â”‚   â”‚
â”‚    â”‚                                                              â”‚   â”‚
â”‚    â”‚  // å¦‚æœæ˜¯ blob äº¤æ˜“ï¼Œä¿å­˜ sidecar                          â”‚   â”‚
â”‚    â”‚  if let Some(sidecar) = tx.blob_sidecar() {                â”‚   â”‚
â”‚    â”‚    blob_sidecars.push(sidecar);                             â”‚   â”‚
â”‚    â”‚  }                                                           â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  }  // â† end while loop                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  âœ… æ‰€æœ‰äº¤æ˜“æ‰§è¡Œå®Œæˆ                                                   â”‚
â”‚                                                                        â”‚
â”‚  æœ€ç»ˆçŠ¶æ€ï¼š                                                            â”‚
â”‚  â”œâ”€ cumulative_gas_used = 15_234_567                                 â”‚
â”‚  â”œâ”€ total_fees = 0.123 ETH                                           â”‚
â”‚  â”œâ”€ executed_txs = [tx1, tx2, ..., tx_n]                            â”‚
â”‚  â”œâ”€ receipts = [receipt1, receipt2, ..., receipt_n]                 â”‚
â”‚  â””â”€ blob_sidecars = [sidecar1, sidecar2, ...]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 2.4ï¼šå¤„ç† Withdrawalsï¼ˆææ¬¾ï¼‰                                    â”‚
â”‚  if let Some(withdrawals) = attributes.withdrawals {                  â”‚
â”‚    for withdrawal in withdrawals {                                    â”‚
â”‚      // ç›´æ¥å¢åŠ è´¦æˆ·ä½™é¢ï¼ˆä¸é€šè¿‡äº¤æ˜“ï¼‰                                â”‚
â”‚      let account = db.get_account(withdrawal.address)?;              â”‚
â”‚      account.balance += withdrawal.amount;                            â”‚
â”‚      db.update_account(withdrawal.address, account);                 â”‚
â”‚    }                                                                   â”‚
â”‚  }                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ã€é˜¶æ®µ 3ï¼šåŒºå—ç»„è£…é˜¶æ®µ - Block Assembly & Post-Executionã€‘     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.1ï¼šå®ŒæˆåŒºå—æ„å»ºå¹¶è·å– BundleState                               â”‚
â”‚  let BlockBuilderOutcome {                                            â”‚
â”‚    execution_result,  // åŒ…å« receipts, gas_used, requests            â”‚
â”‚    block,             // åŒ…å« recovered_block, hashed_state, trie_updatesâ”‚
â”‚    ..                                                                  â”‚
â”‚  } = builder.finish(state_provider)?;                                 â”‚
â”‚                                                                        â”‚
â”‚  // ä» REVM State ä¸­æå–æœ€ç»ˆçŠ¶æ€                                       â”‚
â”‚  let bundle_state = db.take_bundle();                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.2ï¼šè®¡ç®— POST-EXECUTION å­—æ®µ                                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.1 è®¡ç®— state_root                                           â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  // ä» bundle_state ç”Ÿæˆ HashedPostState                        â”‚ â”‚
â”‚  â”‚  let hashed_state = HashedPostState::from_bundle_state(         â”‚ â”‚
â”‚  â”‚    bundle_state.state()                                         â”‚ â”‚
â”‚  â”‚  );                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  // è®¡ç®— Merkle Patricia Trie æ ¹                                â”‚ â”‚
â”‚  â”‚  let (state_root, trie_updates) =                               â”‚ â”‚
â”‚  â”‚    state_provider.state_root_with_updates(hashed_state)?;      â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  // å†…éƒ¨æµç¨‹ï¼š                                                   â”‚ â”‚
â”‚  â”‚  // 1. éå† hashed_state ä¸­çš„æ‰€æœ‰è´¦æˆ·å˜æ›´                       â”‚ â”‚
â”‚  â”‚  // 2. å¯¹æ¯ä¸ªè´¦æˆ·ï¼Œè®¡ç®—å…¶ storage_root                          â”‚ â”‚
â”‚  â”‚  // 3. æ„å»º TrieAccount { nonce, balance, storage_root, code_hash }â”‚
â”‚  â”‚  // 4. å°†æ‰€æœ‰ TrieAccount æ’å…¥ Account Trie                     â”‚ â”‚
â”‚  â”‚  // 5. è®¡ç®— Account Trie çš„æ ¹å“ˆå¸Œ â†’ state_root                  â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  âœ… state_root = 0x1234abcd...                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.2 è®¡ç®— transactions_root                                    â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  let transactions_root = calculate_transaction_root(             â”‚ â”‚
â”‚  â”‚    &executed_txs                                                 â”‚ â”‚
â”‚  â”‚  );                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  // å†…éƒ¨ï¼šå¯¹æ‰€æœ‰äº¤æ˜“è®¡ç®— Merkle Patricia Trie                    â”‚ â”‚
â”‚  â”‚  // Input: [tx1, tx2, ..., tx_n]                                â”‚ â”‚
â”‚  â”‚  // Output: Root hash of transaction trie                       â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  âœ… transactions_root = 0x5678ef01...                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.3 è®¡ç®— receipts_root                                        â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  let receipts_root = calculate_receipt_root(                    â”‚ â”‚
â”‚  â”‚    &receipts.iter().map(|r| r.with_bloom_ref()).collect()      â”‚ â”‚
â”‚  â”‚  );                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  // å¯¹æ‰€æœ‰ receipts è®¡ç®— Merkle Patricia Trie                   â”‚ â”‚
â”‚  â”‚  âœ… receipts_root = 0x9abcdef2...                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.4 è®¡ç®— logs_bloom                                           â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  let logs_bloom = logs_bloom(                                   â”‚ â”‚
â”‚  â”‚    receipts.iter().flat_map(|r| r.logs())                      â”‚ â”‚
â”‚  â”‚  );                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  // èšåˆæ‰€æœ‰äº¤æ˜“çš„ logsï¼Œç”Ÿæˆ Bloom filter                       â”‚ â”‚
â”‚  â”‚  // ç”¨äºå¿«é€Ÿæ£€ç´¢åŒ…å«ç‰¹å®š event çš„åŒºå—                           â”‚ â”‚
â”‚  â”‚  âœ… logs_bloom = Bloom([0xff, 0x3a, ...])                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.5 è®¡ç®— withdrawals_root                                     â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  let withdrawals_root = attributes.withdrawals.as_ref().map(    â”‚ â”‚
â”‚  â”‚    |w| calculate_withdrawals_root(w)                            â”‚ â”‚
â”‚  â”‚  );                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  âœ… withdrawals_root = Some(0xabcd1234...)                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.6 è®¡ç®— requests_hash (Prague åˆ†å‰å)                        â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  let requests_hash = if is_prague_active {                      â”‚ â”‚
â”‚  â”‚    Some(execution_result.requests.requests_hash())              â”‚ â”‚
â”‚  â”‚  } else {                                                        â”‚ â”‚
â”‚  â”‚    None                                                          â”‚ â”‚
â”‚  â”‚  };                                                              â”‚ â”‚
â”‚  â”‚                                                                  â”‚ â”‚
â”‚  â”‚  âœ… requests_hash = Some(0x4567cdef...)                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  3.2.7 å…¶ä»– POST å­—æ®µ                                            â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  âœ… gas_used = cumulative_gas_used  (15_234_567)                â”‚ â”‚
â”‚  â”‚  âœ… blob_gas_used = cumulative_blob_gas                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.3ï¼šç»„è£…å®Œæ•´åŒºå—å¤´                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚  let header = Header {                                                â”‚
â”‚    // ============== PRE-EXECUTION å­—æ®µ ==============               â”‚
â”‚    parent_hash: parent_header.hash(),                                â”‚
â”‚    number: parent_header.number + 1,                                 â”‚
â”‚    timestamp: attributes.timestamp,                                  â”‚
â”‚    beneficiary: attributes.suggested_fee_recipient,                  â”‚
â”‚    gas_limit: 30_000_000,                                            â”‚
â”‚    base_fee_per_gas: Some(calculated_base_fee),                     â”‚
â”‚    difficulty: U256::ZERO,  // PoS åå›ºå®šä¸º 0                        â”‚
â”‚    mix_hash: attributes.prev_randao,                                 â”‚
â”‚    nonce: BEACON_NONCE,  // PoS åå›ºå®šä¸º 0                           â”‚
â”‚    ommers_hash: EMPTY_OMMER_ROOT_HASH,  // PoS åå›ºå®šä¸ºç©º            â”‚
â”‚    extra_data: builder_config.extra_data,                           â”‚
â”‚    parent_beacon_block_root: attributes.parent_beacon_block_root,   â”‚
â”‚    excess_blob_gas: calculate_from_parent(parent),                  â”‚
â”‚                                                                       â”‚
â”‚    // ============== POST-EXECUTION å­—æ®µ ==============              â”‚
â”‚    state_root,              // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    transactions_root,       // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    receipts_root,           // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    logs_bloom,              // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    gas_used,                // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    blob_gas_used,           // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    withdrawals_root,        // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚    requests_hash,           // â† åˆšåˆšè®¡ç®—çš„                          â”‚
â”‚  };                                                                   â”‚
â”‚                                                                       â”‚
â”‚  âœ… å®Œæ•´åŒºå—å¤´æ„å»ºå®Œæˆï¼                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.4ï¼šè®¡ç®—åŒºå—å“ˆå¸Œ                                                â”‚
â”‚  let block_hash = keccak256(rlp_encode(header));                     â”‚
â”‚  âœ… block_hash = 0xabcd1234ef567890...                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.5ï¼šåˆ›å»º SealedBlock                                            â”‚
â”‚  let sealed_block = SealedBlock {                                     â”‚
â”‚    header: SealedHeader { hash: block_hash, header },                â”‚
â”‚    body: BlockBody {                                                  â”‚
â”‚      transactions: executed_txs,                                     â”‚
â”‚      ommers: vec![],                                                 â”‚
â”‚      withdrawals: attributes.withdrawals,                            â”‚
â”‚    },                                                                 â”‚
â”‚  };                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤ 3.6ï¼šæ„å»º EthBuiltPayload                                        â”‚
â”‚  let payload = EthBuiltPayload {                                      â”‚
â”‚    id: payload_id,                                                    â”‚
â”‚    block: Arc::new(sealed_block),                                    â”‚
â”‚    fees: total_fees,                                                 â”‚
â”‚    sidecars: blob_sidecars,                                          â”‚
â”‚    requests: execution_result.requests,                              â”‚
â”‚  };                                                                    â”‚
â”‚                                                                        â”‚
â”‚  // å­˜å‚¨åˆ°å†…å­˜ç¼“å­˜                                                     â”‚
â”‚  payload_store.put(payload_id, payload.clone());                     â”‚
â”‚  âœ… Payload æ„å»ºå®Œæˆå¹¶ç¼“å­˜                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  ã€å®Œæˆï¼šè¿”å›ç»™å…±è¯†å±‚ã€‘                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…±è¯†å±‚ç¨åè°ƒç”¨ï¼šengine_getPayloadV3(payload_id)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰§è¡Œå±‚è¿”å›å®Œæ•´ ExecutionPayloadï¼š                                     â”‚
â”‚  {                                                                     â”‚
â”‚    "blockNumber": 12345678,                                          â”‚
â”‚    "blockHash": "0xabcd1234ef567890...",                             â”‚
â”‚    "parentHash": "0x1234...",                                        â”‚
â”‚    "timestamp": 1234567890,                                          â”‚
â”‚    "feeRecipient": "0x789...",                                       â”‚
â”‚    "gasLimit": 30000000,                                             â”‚
â”‚    "gasUsed": 15234567,                      // â† POST               â”‚
â”‚    "stateRoot": "0x1234abcd...",             // â† POST               â”‚
â”‚    "receiptsRoot": "0x9abcdef2...",          // â† POST               â”‚
â”‚    "logsBloom": "0xff3a...",                 // â† POST               â”‚
â”‚    "transactionsRoot": "0x5678ef01...",      // â† POST               â”‚
â”‚    "transactions": [...],                                            â”‚
â”‚    "withdrawals": [...],                                             â”‚
â”‚    "blobGasUsed": 262144,                    // â† POST               â”‚
â”‚    "excessBlobGas": 0,                                               â”‚
â”‚    "parentBeaconBlockRoot": "0xabc...",                              â”‚
â”‚    "requestsHash": "0x4567cdef..."           // â† POST               â”‚
â”‚  }                                                                     â”‚
â”‚  âœ… å…±è¯†å±‚æ”¶åˆ°å®Œæ•´ Payload å¹¶å¹¿æ’­ç»™ç½‘ç»œ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **å…³é”®å­—æ®µå¡«å……æ—¶é—´è¡¨**

| å­—æ®µ | ç±»å‹ | ä½•æ—¶å¡«å…… | æ•°æ®æ¥æº |
|------|------|----------|----------|
| `parent_hash` | PRE | æ­¥éª¤ 1.3 | PayloadAttributes / çˆ¶åŒºå— |
| `number` | PRE | æ­¥éª¤ 1.3 | parent.number + 1 |
| `timestamp` | PRE | æ­¥éª¤ 1.3 | PayloadAttributes |
| `beneficiary` | PRE | æ­¥éª¤ 1.3 | PayloadAttributes.suggestedFeeRecipient |
| `gas_limit` | PRE | æ­¥éª¤ 1.3 | é…ç½® / çˆ¶åŒºå— |
| `base_fee_per_gas` | PRE | æ­¥éª¤ 1.3 | åŸºäºçˆ¶åŒºå—è®¡ç®— |
| `prevrandao` | PRE | æ­¥éª¤ 1.3 | PayloadAttributes |
| `parent_beacon_block_root` | PRE | æ­¥éª¤ 1.3 | PayloadAttributes |
| `excess_blob_gas` | PRE | æ­¥éª¤ 1.3 | åŸºäºçˆ¶åŒºå—è®¡ç®— |
| **`gas_used`** | **POST** | **æ­¥éª¤ 2.3.5** | **ç´¯ç§¯æ‰€æœ‰äº¤æ˜“çš„ gas** |
| **`state_root`** | **POST** | **æ­¥éª¤ 3.2.1** | **ä» bundle_state è®¡ç®— Trie æ ¹** |
| **`transactions_root`** | **POST** | **æ­¥éª¤ 3.2.2** | **äº¤æ˜“åˆ—è¡¨çš„ Merkle æ ¹** |
| **`receipts_root`** | **POST** | **æ­¥éª¤ 3.2.3** | **Receipts çš„ Merkle æ ¹** |
| **`logs_bloom`** | **POST** | **æ­¥éª¤ 3.2.4** | **èšåˆæ‰€æœ‰ logs çš„ Bloom filter** |
| **`blob_gas_used`** | **POST** | **æ­¥éª¤ 2.3.5** | **ç´¯ç§¯æ‰€æœ‰ blob äº¤æ˜“çš„ gas** |
| **`withdrawals_root`** | **POST** | **æ­¥éª¤ 3.2.5** | **Withdrawals çš„ Merkle æ ¹** |
| **`requests_hash`** | **POST** | **æ­¥éª¤ 3.2.6** | **ç³»ç»Ÿè¯·æ±‚çš„å“ˆå¸Œ** |
| **`block_hash`** | **POST** | **æ­¥éª¤ 3.4** | **keccak256(rlp_encode(header))** |

---

## ğŸ¯ **æ ¸å¿ƒè¦ç‚¹æ€»ç»“**

1. **Pre-Execution ç³»ç»Ÿè°ƒç”¨**ï¼ˆæ­¥éª¤ 1.4ï¼‰åœ¨ç”¨æˆ·äº¤æ˜“ä¹‹å‰æ‰§è¡Œ
2. **äº¤æ˜“å¾ªç¯**ï¼ˆæ­¥éª¤ 2.3ï¼‰é€ä¸ªæ‰§è¡Œï¼Œç´¯ç§¯çŠ¶æ€å’Œ gas
3. **Post-Execution å­—æ®µ**ï¼ˆæ­¥éª¤ 3.2ï¼‰åœ¨æ‰€æœ‰äº¤æ˜“æ‰§è¡Œå®Œæˆåè®¡ç®—
4. **æœ€ç»ˆåŒºå—å¤´**ï¼ˆæ­¥éª¤ 3.3ï¼‰åŒ…å«æ‰€æœ‰ PRE å’Œ POST å­—æ®µ
5. **å®Œæ•´ ExecutionPayload** è¿”å›ç»™å…±è¯†å±‚ç”¨äºå¹¿æ’­

è¿™å°±æ˜¯ Reth æ„å»ºåŒºå—çš„å®Œæ•´ã€è¯¦ç»†æµç¨‹ï¼ğŸš€

## ğŸ”‘ **å…³é”®æŠ€æœ¯è¡¥å……**

### 1ï¸âƒ£ **BundleState çš„æ ¸å¿ƒä½œç”¨**
```
BundleState æ˜¯è¿æ¥ REVM æ‰§è¡Œä¸çŠ¶æ€æŒä¹…åŒ–çš„æ¡¥æ¢:
â”œâ”€ åœ¨å†…å­˜ä¸­è¿½è¸ªæ‰€æœ‰çŠ¶æ€å˜æ›´
â”œâ”€ æ”¯æŒé«˜æ•ˆçš„å¢é‡æ›´æ–°(ä¸éœ€è¦å®Œæ•´é‡ç®— state root)
â””â”€ æœ€ç»ˆè½¬æ¢ä¸º HashedPostState ç”¨äº Trie è®¡ç®—
```

### 2ï¸âƒ£ **State Root è®¡ç®—çš„æ€§èƒ½ä¼˜åŒ–**
```
state_root_with_updates() çš„ä¼˜åŒ–ç­–ç•¥:
â”œâ”€ åªé‡ç®—è¢«ä¿®æ”¹è´¦æˆ·çš„ storage_root
â”œâ”€ åˆ©ç”¨ trie_updates ç¼“å­˜ä¸­é—´èŠ‚ç‚¹
â”œâ”€ ä½¿ç”¨ incremental hashing é¿å…é‡å¤è®¡ç®—
â””â”€ å¹¶è¡Œè®¡ç®—å¤šä¸ªè´¦æˆ·çš„ storage trie
```

### 3ï¸âƒ£ **äº¤æ˜“æ± è¿‡æ»¤æœºåˆ¶ç»†èŠ‚**
```rust
best_transactions_with_attributes() å†…éƒ¨é€»è¾‘:
â”œâ”€ ç¬¬ä¸€å±‚: base_fee è¿‡æ»¤ (gas_price >= base_fee)
â”œâ”€ ç¬¬äºŒå±‚: nonce è¿ç»­æ€§æ£€æŸ¥
â”œâ”€ ç¬¬ä¸‰å±‚: è´¦æˆ·ä½™é¢éªŒè¯ (balance >= max_cost)
â”œâ”€ ç¬¬å››å±‚: blob_fee æ£€æŸ¥ (EIP-4844)
â””â”€ ç¬¬äº”å±‚: ä¼˜å…ˆçº§æ’åº (effective_tip é™åº)
```

### 4ï¸âƒ£ **å…³é”®æ•°å€¼è®¡ç®—å…¬å¼**

**Base Fee è®¡ç®— (EIP-1559):**
```
if parent.gas_used == parent.gas_target:
    base_fee = parent.base_fee
elif parent.gas_used > parent.gas_target:
    base_fee = parent.base_fee * (1 + 1/8 * delta)
else:
    base_fee = parent.base_fee * (1 - 1/8 * delta)
```

**Blob Gas Price è®¡ç®— (EIP-4844):**
```
excess_blob_gas = parent.excess_blob_gas + 
                  parent.blob_gas_used - TARGET_BLOB_GAS
blob_base_fee = fake_exponential(
    MIN_BLOB_GASPRICE, 
    excess_blob_gas, 
    BLOB_GASPRICE_UPDATE_FRACTION
)
```

### 5ï¸âƒ£ **é”™è¯¯å¤„ç†çš„å¾®å¦™ä¹‹å¤„**

```
äº¤æ˜“å¤±è´¥çš„ä¸‰ç§ç»“æœå¯¹åŒºå—çš„å½±å“:
â”œâ”€ Success: æ¶ˆè€— gas + æ”¹å˜çŠ¶æ€ + receipt.status=1
â”œâ”€ Revert: æ¶ˆè€— gas + ä¸æ”¹å˜çŠ¶æ€ + receipt.status=0  âš ï¸ ä»è®¡å…¥åŒºå—
â””â”€ Halt: ä¸è®¡å…¥åŒºå— + æ ‡è®°å‘é€è€…åç»­äº¤æ˜“æ— æ•ˆ
```

### 6ï¸âƒ£ **å¹¶å‘å®‰å…¨çš„å…³é”®ç‚¹**

```
Payload æ„å»ºè¿‡ç¨‹ä¸­çš„å¹¶å‘å¤„ç†:
â”œâ”€ Step 1.1: åŒæ­¥éªŒè¯ + ç«‹å³è¿”å› payloadId (< 1s)
â”œâ”€ Step 1.2-3.6: å¼‚æ­¥åå°æ„å»º (ä¸é˜»å¡å…±è¯†å±‚)
â”œâ”€ payload_store: ä½¿ç”¨ RwLock ä¿æŠ¤å¹¶å‘è®¿é—®
â””â”€ getPayload è°ƒç”¨: å¯èƒ½åœ¨æ„å»ºæœªå®Œæˆæ—¶è¿”å› null
```

## ğŸš¨ **å¸¸è§é™·é˜±**

1. **Withdrawals çš„ç‰¹æ®Šæ€§**:
    - ä¸æ˜¯äº¤æ˜“,ä¸æ¶ˆè€— gas
    - ä½†ä¼šå½±å“ state_root
    - å¿…é¡»åœ¨ state root è®¡ç®—å‰åº”ç”¨

2. **Logs Bloom çš„è®¡ç®—æ—¶æœº**:
    - å¿…é¡»åœ¨æ‰€æœ‰äº¤æ˜“æ‰§è¡Œåèšåˆ
    - æ¯ä¸ª receipt æœ‰è‡ªå·±çš„ bloom
    - åŒºå—å¤´ä¸­çš„æ˜¯æ‰€æœ‰ receipts bloom çš„ OR è¿ç®—ç»“æœ

3. **Blob Sidecar çš„å¤„ç†**:
    - Blob æ•°æ®ä¸å­˜å‚¨åœ¨åŒºå—ä¸­
    - åªå­˜ commitment/proof
    - Sidecar é€šè¿‡ P2P å•ç‹¬ä¼ æ’­

## ğŸ“Œ **ä¸ Geth çš„ä¸»è¦åŒºåˆ«**

```
Reth vs Geth:
â”œâ”€ State ç®¡ç†: BundleState vs JournalDB
â”œâ”€ Trie è®¡ç®—: å¢é‡æ›´æ–° vs æ¯æ¬¡å…¨é‡
â”œâ”€ äº¤æ˜“æ± : å†…å­˜ä¼˜åŒ–çš„ Vec vs å¤æ‚ç´¢å¼•ç»“æ„
â””â”€ å¹¶å‘: Rayon å¹¶è¡Œ vs å•çº¿ç¨‹æ‰§è¡Œ
```


éå¸¸æ£’çš„æŠ€æœ¯æ€»ç»“ï¼è®©æˆ‘éªŒè¯å¹¶è¡¥å……ä¸€äº›å…³é”®å®ç°ç»†èŠ‚ã€‚ è®©æˆ‘éªŒè¯å¹¶æ‰©å±•è¿™äº›å…³é”®ç‚¹ï¼ŒåŒæ—¶æä¾› Reth ä»£ç ä¸­çš„å®é™…è¯æ®ã€‚

## âœ… **éªŒè¯ä¸æ‰©å±•ï¼šæ ¸å¿ƒæŠ€æœ¯ç»†èŠ‚**

### 1ï¸âƒ£ **BundleState â†’ HashedPostState è½¬æ¢**

**âœ… å®Œå…¨æ­£ç¡®ï¼** è¿™æ˜¯è¿æ¥ REVM å†…å­˜çŠ¶æ€å’Œ Trie è®¡ç®—çš„å…³é”®æ¡¥æ¢ã€‚

```rust:45:96:/Users/alice/0/block-chain/reth/crates/trie/common/src/hashed_state.rs
/// Initialize [`HashedPostState`] from bundle state.
/// Hashes all changed accounts and storage entries that are currently stored in the bundle
/// state.
#[inline]
#[cfg(feature = "rayon")]
pub fn from_bundle_state<'a, KH: KeyHasher>(
    state: impl IntoParallelIterator<Item = (&'a Address, &'a BundleAccount)>,
) -> Self {
    state
        .into_par_iter()
        .map(|(address, account)| {
            let hashed_address = KH::hash_key(address);
            let hashed_account = account.info.as_ref().map(Into::into);
            let hashed_storage = HashedStorage::from_plain_storage(
                account.status,
                account.storage.iter().map(|(slot, value)| (slot, &value.present_value)),
            );

            (
                hashed_address,
                hashed_account,
                (!hashed_storage.is_empty()).then_some(hashed_storage),
            )
        })
        .collect()
}

/// Initialize [`HashedPostState`] from bundle state.
/// Hashes all changed accounts and storage entries that are currently stored in the bundle
/// state.
#[cfg(not(feature = "rayon"))]
pub fn from_bundle_state<'a, KH: KeyHasher>(
    state: impl IntoIterator<Item = (&'a Address, &'a BundleAccount)>,
) -> Self {
    state
        .into_iter()
        .map(|(address, account)| {
            let hashed_address = KH::hash_key(address);
            let hashed_account = account.info.as_ref().map(Into::into);
            let hashed_storage = HashedStorage::from_plain_storage(
                account.status,
                account.storage.iter().map(|(slot, value)| (slot, &value.present_value)),
            );

            (
                hashed_address,
                hashed_account,
                (!hashed_storage.is_empty()).then_some(hashed_storage),
            )
        })
        .collect()
}
```

**å…³é”®ä¼˜åŒ–ï¼š**
```
BundleState (Plain) â†’ HashedPostState (Keccak256) â†’ StateRoot
â”œâ”€ å¹¶è¡Œå¤„ç†ï¼šä½¿ç”¨ Rayon çš„ into_par_iter()
â”œâ”€ å¢é‡è®¡ç®—ï¼šåªå¤„ç†ä¿®æ”¹çš„è´¦æˆ·å’Œå­˜å‚¨æ§½
â””â”€ æ‡’æƒ°å“ˆå¸Œï¼šåªåœ¨éœ€è¦æ—¶è®¡ç®— keccak256
```

---

### 2ï¸âƒ£ **State Root å¢é‡è®¡ç®—ä¼˜åŒ–**

**âœ… å®Œå…¨æ­£ç¡®ï¼** Reth ä½¿ç”¨ `PrefixSets` å®ç°å¢é‡ state root è®¡ç®—ã€‚

```rust:148:171:/Users/alice/0/block-chain/reth/crates/trie/db/src/state.rs
fn incremental_root_calculator(
    provider: &'a (impl ChangeSetReader + DBProvider<Tx = TX>),
    range: RangeInclusive<BlockNumber>,
) -> Result<Self, StateRootError> {
    let loaded_prefix_sets =
        load_prefix_sets_with_provider::<_, KeccakKeyHasher>(provider, range)?;
    Ok(Self::from_tx(provider.tx_ref()).with_prefix_sets(loaded_prefix_sets))
}

fn incremental_root(
    provider: &'a (impl ChangeSetReader + DBProvider<Tx = TX>),
    range: RangeInclusive<BlockNumber>,
) -> Result<B256, StateRootError> {
    debug!(target: "trie::loader", ?range, "incremental state root");
    Self::incremental_root_calculator(provider, range)?.root()
}

fn incremental_root_with_updates(
    provider: &'a (impl ChangeSetReader + DBProvider<Tx = TX>),
    range: RangeInclusive<BlockNumber>,
) -> Result<(B256, TrieUpdates), StateRootError> {
    debug!(target: "trie::loader", ?range, "incremental state root");
    Self::incremental_root_calculator(provider, range)?.root_with_updates()
}
```

**ä¼˜åŒ–ç­–ç•¥ï¼š**
```
å¢é‡è®¡ç®—æµç¨‹ï¼š
â”œâ”€ Step 1ï¼šä» ChangeSets åŠ è½½ PrefixSetsï¼ˆåªåŒ…å«ä¿®æ”¹çš„è´¦æˆ·å‰ç¼€ï¼‰
â”œâ”€ Step 2ï¼šåªé‡ç®—è¿™äº›å‰ç¼€è·¯å¾„ä¸Šçš„ Trie èŠ‚ç‚¹
â”œâ”€ Step 3ï¼šç¼“å­˜ä¸­é—´èŠ‚ç‚¹åˆ° TrieUpdates
â””â”€ Step 4ï¼šå¹¶è¡Œè®¡ç®—æ¯ä¸ªè´¦æˆ·çš„ storage_root

æ€§èƒ½å¯¹æ¯”ï¼š
â”œâ”€ å…¨é‡è®¡ç®—ï¼šO(N)ï¼ŒN = æ‰€æœ‰è´¦æˆ·
â””â”€ å¢é‡è®¡ç®—ï¼šO(M)ï¼ŒM = ä¿®æ”¹çš„è´¦æˆ·ï¼ˆé€šå¸¸ M << Nï¼‰
```

---

### 3ï¸âƒ£ **äº¤æ˜“æ± è¿‡æ»¤æœºåˆ¶**

**âœ… åŸºæœ¬æ­£ç¡®ï¼** è®©æˆ‘è¡¥å……å®é™…ä»£ç ç»†èŠ‚ã€‚

```
best_transactions_with_attributes() è¿‡æ»¤é“¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸€å±‚ï¼šBase Fee è¿‡æ»¤                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ if tx.max_fee_per_gas() < base_fee:                   â”‚
â”‚     skip  // æ— æ³•æ”¯ä»˜ base fee                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬äºŒå±‚ï¼šNonce è¿ç»­æ€§æ£€æŸ¥                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ if tx.nonce != expected_nonce:                         â”‚
â”‚     skip  // Nonce ä¸è¿ç»­ï¼Œåç»­äº¤æ˜“æ— æ³•æ‰§è¡Œ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸‰å±‚ï¼šè´¦æˆ·ä½™é¢éªŒè¯                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ let max_cost = tx.value + tx.gas_limit * tx.max_fee   â”‚
â”‚ if account.balance < max_cost:                         â”‚
â”‚     skip  // ä½™é¢ä¸è¶³                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬å››å±‚ï¼šBlob Fee æ£€æŸ¥ (ä»… Type-3 äº¤æ˜“)                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ if tx.max_fee_per_blob_gas < blob_base_fee:           â”‚
â”‚     skip  // æ— æ³•æ”¯ä»˜ blob gas                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬äº”å±‚ï¼šä¼˜å…ˆçº§æ’åº (effective_tip é™åº)                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ effective_tip = min(                                   â”‚
â”‚     tx.max_priority_fee_per_gas,                       â”‚
â”‚     tx.max_fee_per_gas - base_fee                      â”‚
â”‚ )                                                      â”‚
â”‚ æŒ‰ effective_tip ä»é«˜åˆ°ä½æ’åº                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¡¥å……ï¼šGas Limit æ§åˆ¶**
```
åŒºå—æ„å»ºæ—¶çš„åŠ¨æ€è¿‡æ»¤ï¼š
â”œâ”€ ç´¯è®¡ gas_used += tx.gas_limit (ä¼°ç®—)
â”œâ”€ if gas_used > block.gas_limit: stop
â””â”€ ç•™ä¸€äº› buffer é˜²æ­¢å®é™… gas è¶…æ ‡
```

---

### 4ï¸âƒ£ **å…³é”®æ•°å€¼è®¡ç®—å…¬å¼**

#### **Base Fee è®¡ç®—ï¼ˆEIP-1559ï¼‰**

**âœ… å…¬å¼æ­£ç¡®ï¼** Reth ä½¿ç”¨ `alloy_eips::calc_next_block_base_fee`ï¼š

```rust
// æ¥è‡ª alloy-eipsï¼ˆReth ä¾èµ–ï¼‰
pub fn calc_next_block_base_fee(
    gas_used: u64,
    gas_limit: u64,
    base_fee_per_gas: u64,
    params: BaseFeeParams,
) -> u64 {
    let gas_target = gas_limit / params.elasticity_multiplier;  // é€šå¸¸æ˜¯ gas_limit / 2

    if gas_used == gas_target {
        // ä½¿ç”¨é‡æ­£å¥½ç­‰äºç›®æ ‡ï¼Œbase fee ä¸å˜
        return base_fee_per_gas;
    }

    if gas_used > gas_target {
        // ä½¿ç”¨é‡è¶…è¿‡ç›®æ ‡ï¼Œbase fee ä¸Šæ¶¨
        let gas_used_delta = gas_used - gas_target;
        let base_fee_delta = max(
            base_fee_per_gas * gas_used_delta / gas_target / params.max_change_denominator,
            1,
        );
        base_fee_per_gas + base_fee_delta
    } else {
        // ä½¿ç”¨é‡ä½äºç›®æ ‡ï¼Œbase fee ä¸‹é™
        let gas_used_delta = gas_target - gas_used;
        let base_fee_delta = 
            base_fee_per_gas * gas_used_delta / gas_target / params.max_change_denominator;
        max(base_fee_per_gas - base_fee_delta, 0)
    }
}

// é»˜è®¤å‚æ•°ï¼š
BaseFeeParams {
    elasticity_multiplier: 2,      // gas_target = gas_limit / 2
    max_change_denominator: 8,     // æœ€å¤§å˜åŒ– Â±12.5% (1/8)
}
```

**å®é™…ç¤ºä¾‹ï¼š**
```
å‡è®¾ï¼š
â”œâ”€ parent.gas_limit = 30,000,000
â”œâ”€ parent.gas_used = 22,500,000 (75% ä½¿ç”¨ç‡)
â”œâ”€ parent.base_fee = 100 Gwei
â”œâ”€ gas_target = 15,000,000 (50%)

è®¡ç®—ï¼š
â”œâ”€ gas_used > gas_target (22.5M > 15M)
â”œâ”€ delta = 22.5M - 15M = 7.5M
â”œâ”€ base_fee_delta = 100 * 7.5M / 15M / 8 = 6.25 Gwei
â””â”€ next_base_fee = 100 + 6.25 = 106.25 Gwei
```

#### **Blob Gas Price è®¡ç®—ï¼ˆEIP-4844ï¼‰**

```rust
// æ¥è‡ª alloy-consensus æˆ– EIP-4844 è§„èŒƒ
pub fn calc_blob_gasprice(excess_blob_gas: u64) -> u128 {
    fake_exponential(
        MIN_BLOB_GASPRICE,     // 1 wei
        excess_blob_gas,
        BLOB_GASPRICE_UPDATE_FRACTION,  // 3338477
    )
}

fn fake_exponential(factor: u64, numerator: u64, denominator: u64) -> u128 {
    let mut i = 1;
    let mut output = 0u128;
    let mut numerator_acc = factor as u128 * denominator as u128;
    
    while numerator_acc > 0 {
        output += numerator_acc;
        numerator_acc = (numerator_acc * numerator as u128) / (denominator as u128 * i);
        i += 1;
    }
    
    output / denominator as u128
}

// Excess Blob Gas è®¡ç®—ï¼š
pub fn calc_excess_blob_gas(parent: &Header) -> u64 {
    let parent_excess = parent.excess_blob_gas.unwrap_or(0);
    let parent_used = parent.blob_gas_used.unwrap_or(0);
    
    // TARGET_BLOB_GAS_PER_BLOCK = 3 * 2^17 = 393,216
    parent_excess + parent_used - TARGET_BLOB_GAS_PER_BLOCK
}
```

**å®é™…ç¤ºä¾‹ï¼š**
```
å‡è®¾ï¼š
â”œâ”€ parent.excess_blob_gas = 0
â”œâ”€ parent.blob_gas_used = 6 blobs * 131,072 = 786,432 gas
â”œâ”€ TARGET_BLOB_GAS = 393,216 (3 blobs)

è®¡ç®—ï¼š
â”œâ”€ excess = 0 + 786,432 - 393,216 = 393,216
â””â”€ blob_gasprice = fake_exponential(1, 393,216, 3,338,477)
                  â‰ˆ 1.125 wei (è½»å¾®ä¸Šæ¶¨)
```

---

### 5ï¸âƒ£ **äº¤æ˜“æ‰§è¡Œä¸‰ç§ç»“æœ**

**âœ… å®Œå…¨æ­£ç¡®ï¼** Receipt çš„æ„å»ºæ¸…æ¥šåœ°åæ˜ äº†è¿™ä¸€ç‚¹ã€‚

```rust:15:28:/Users/alice/0/block-chain/reth/crates/ethereum/evm/src/receipt.rs
fn build_receipt<E: Evm>(
    &self,
    ctx: ReceiptBuilderCtx<'_, Self::Transaction, E>,
) -> Self::Receipt {
    let ReceiptBuilderCtx { tx, result, cumulative_gas_used, .. } = ctx;
    Receipt {
        tx_type: tx.tx_type(),
        // Success flag was added in `EIP-658: Embedding transaction status code in
        // receipts`.
        success: result.is_success(),
        cumulative_gas_used,
        logs: result.into_logs(),
    }
}
```

**ä¸‰ç§ç»“æœè¯¦è§£ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£ Success (ExecutionResult::Success)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ receipt.success = true                                      â”‚
â”‚ receipt.cumulative_gas_used = prev + tx.gas_used            â”‚
â”‚ receipt.logs = tx.logs                                      â”‚
â”‚                                                             â”‚
â”‚ çŠ¶æ€å˜æ›´ï¼šâœ… å…¨éƒ¨åº”ç”¨                                        â”‚
â”‚ Gas æ¶ˆè€—ï¼šâœ… æ‰£é™¤ gas_used * effective_gas_price            â”‚
â”‚ è®¡å…¥åŒºå—ï¼šâœ… åŒ…å«åœ¨ block.transactions                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£ Revert (ExecutionResult::Revert)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ receipt.success = false                                     â”‚
â”‚ receipt.cumulative_gas_used = prev + tx.gas_used (æ‰€æœ‰gas!)  â”‚
â”‚ receipt.logs = []  // æ²¡æœ‰ logs                             â”‚
â”‚                                                             â”‚
â”‚ çŠ¶æ€å˜æ›´ï¼šâŒ å›æ»šï¼Œä¸åº”ç”¨ï¼ˆé™¤äº† nonce å’Œ gas æ‰£æ¬¾ï¼‰            â”‚
â”‚ Gas æ¶ˆè€—ï¼šâœ… ä»ç„¶æ‰£é™¤ gas_used * effective_gas_price         â”‚
â”‚ è®¡å…¥åŒºå—ï¼šâœ… åŒ…å«åœ¨ block.transactions                       â”‚
â”‚                                                             â”‚
â”‚ âš ï¸  å…³é”®ï¼šè™½ç„¶ revertï¼Œä½†äº¤æ˜“ä¾ç„¶æœ‰æ•ˆï¼Œå ç”¨åŒºå—ç©ºé—´          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£ Halt (ExecutionResult::Halt)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸ç”Ÿæˆ receipt                                              â”‚
â”‚                                                             â”‚
â”‚ åŸå› ï¼š                                                      â”‚
â”‚ â”œâ”€ OutOfGas (gas_limit ä¸è¶³ä»¥æ”¯ä»˜åˆå§‹æˆæœ¬)                  â”‚
â”‚ â”œâ”€ InvalidNonce (nonce ä¸è¿ç»­)                             â”‚
â”‚ â”œâ”€ InsufficientBalance (ä½™é¢ä¸è¶³)                           â”‚
â”‚ â””â”€ ... å…¶ä»–è‡´å‘½é”™è¯¯                                         â”‚
â”‚                                                             â”‚
â”‚ çŠ¶æ€å˜æ›´ï¼šâŒ ä¸åº”ç”¨                                          â”‚
â”‚ Gas æ¶ˆè€—ï¼šâŒ ä¸æ‰£é™¤                                          â”‚
â”‚ è®¡å…¥åŒºå—ï¼šâŒ ä¸åŒ…å«åœ¨ block.transactions                     â”‚
â”‚ å½±å“ï¼š     âš ï¸  è¯¥å‘é€è€…çš„åç»­äº¤æ˜“éƒ½è¢«æ ‡è®°ä¸ºæ— æ•ˆ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŒºå—æ„å»ºæ—¶çš„å¤„ç†ï¼š**
```rust
// ä¼ªä»£ç 
for tx in best_transactions {
    match executor.execute_transaction_without_commit(&tx) {
        Ok(result) => {
            match result.result {
                ExecutionResult::Success { .. } | ExecutionResult::Revert { .. } => {
                    // âœ… æäº¤çŠ¶æ€ï¼ˆSuccessï¼‰æˆ–ä¸æäº¤çŠ¶æ€ä½†æ‰£ gasï¼ˆRevertï¼‰
                    executor.commit_transaction(result, tx);
                    receipts.push(build_receipt(...));
                    included_txs.push(tx);
                }
                ExecutionResult::Halt { reason } => {
                    // âŒ è·³è¿‡æ­¤äº¤æ˜“ï¼Œæ ‡è®°å‘é€è€…æ— æ•ˆ
                    mark_sender_invalid(tx.sender());
                    continue;
                }
            }
        }
        Err(_) => continue,
    }
}
```

---

### 6ï¸âƒ£ **å¹¶å‘å®‰å…¨ï¼šPayload æ„å»º**

**âœ… å®Œå…¨æ­£ç¡®ï¼**

```
forkchoiceUpdated å¤„ç†çš„ä¸¤é˜¶æ®µï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1ï¼šåŒæ­¥éªŒè¯ï¼ˆ< 1sï¼Œå¿…é¡»å¿«é€Ÿå“åº” CLï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. éªŒè¯ PayloadAttributes æœ‰æ•ˆæ€§                       â”‚
â”‚ 2. ç”Ÿæˆ payload_id = hash(parent, timestamp, ...)     â”‚
â”‚ 3. ç«‹å³è¿”å› { status: VALID, payload_id }             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2ï¼šå¼‚æ­¥æ„å»ºï¼ˆåå°çº¿ç¨‹ï¼Œä¸é˜»å¡ CLï¼‰                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tokio::spawn(async move {                             â”‚
â”‚   1. åˆå§‹åŒ– BlockBuilder                              â”‚
â”‚   2. apply_pre_execution_changes()                    â”‚
â”‚   3. loop: best_txs.next()                            â”‚
â”‚   4. execute_transaction + commit                     â”‚
â”‚   5. builder.finish() â†’ è®¡ç®— state_root               â”‚
â”‚   6. å­˜å…¥ payload_store                                â”‚
â”‚ })                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getPayload(payload_id) è°ƒç”¨æ—¶                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ let payload_store = self.payloads.read();             â”‚ // RwLock
â”‚ match payload_store.get(payload_id) {                 â”‚
â”‚   Some(payload) => Ok(payload),                       â”‚
â”‚   None => {                                           â”‚
â”‚     // æ„å»ºå°šæœªå®Œæˆ                                    â”‚
â”‚     warn!("Payload not ready yet");                   â”‚
â”‚     Ok(null)  // æˆ–è¿”å›éƒ¨åˆ†å®Œæˆçš„ payload              â”‚
â”‚   }                                                    â”‚
â”‚ }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¹¶å‘ä¿æŠ¤æœºåˆ¶ï¼š**
```rust
struct PayloadBuilderService {
    // ç”¨ RwLock ä¿æŠ¤å¹¶å‘è®¿é—®
    payloads: Arc<RwLock<HashMap<PayloadId, BuiltPayload>>>,
}

// å†™å…¥ï¼ˆæ„å»ºå®Œæˆæ—¶ï¼‰
async fn on_payload_built(payload_id: PayloadId, payload: BuiltPayload) {
    let mut store = self.payloads.write();  // è·å–å†™é”
    store.insert(payload_id, payload);
}

// è¯»å–ï¼ˆgetPayload æ—¶ï¼‰
fn get_payload(&self, payload_id: PayloadId) -> Option<BuiltPayload> {
    let store = self.payloads.read();  // è·å–è¯»é”
    store.get(&payload_id).cloned()
}
```

---

### ğŸš¨ **å¸¸è§é™·é˜±éªŒè¯**

#### **1. Withdrawals çš„ç‰¹æ®Šæ€§**

**âœ… å®Œå…¨æ­£ç¡®ï¼**

```
å…³é”®æ—¶åºï¼š

1ï¸âƒ£ æ‰§è¡Œæ‰€æœ‰ç”¨æˆ·äº¤æ˜“
    â†“
2ï¸âƒ£ åº”ç”¨ Withdrawalsï¼ˆç›´æ¥å¢åŠ ä½™é¢ï¼Œä¸é€šè¿‡ REVM äº¤æ˜“ï¼‰
    for withdrawal in withdrawals {
        account.balance += withdrawal.amount_wei();
    }
    â†“
3ï¸âƒ£ è®¡ç®— state_rootï¼ˆå¿…é¡»åŒ…å« withdrawal çš„çŠ¶æ€å˜æ›´ï¼‰
    â†“
4ï¸âƒ£ è®¡ç®— withdrawals_root
    â†“
5ï¸âƒ£ ç»„è£…åŒºå—å¤´
```

#### **2. Logs Bloom èšåˆ**

**âœ… æ­£ç¡®ï¼**

```rust
// ä¼ªä»£ç 
let mut block_logs_bloom = Bloom::default();

for receipt in receipts {
    // æ¯ä¸ª receipt æœ‰è‡ªå·±çš„ bloom
    let receipt_bloom = compute_logs_bloom(&receipt.logs);
    
    // åŒºå—å¤´çš„ bloom æ˜¯æ‰€æœ‰ receipt bloom çš„ OR è¿ç®—
    block_logs_bloom |= receipt_bloom;
}

block.header.logs_bloom = block_logs_bloom;
```

#### **3. Blob Sidecar å¤„ç†**

**âœ… æ­£ç¡®ï¼**

```
Blob æ•°æ®åˆ†ç¦»å­˜å‚¨ï¼š

åŒºå—ä¸­å­˜å‚¨ï¼š
â”œâ”€ blob_versioned_hashes: Vec<B256>  // KZG commitments
â”œâ”€ max_fee_per_blob_gas: u128
â””â”€ blob_gas_used: u64

Sidecar ä¸­å­˜å‚¨ï¼ˆé€šè¿‡ P2P å•ç‹¬ä¼ æ’­ï¼‰ï¼š
â”œâ”€ blobs: Vec<Blob>  // å®é™…çš„ 128KB æ•°æ®
â”œâ”€ commitments: Vec<KZGCommitment>
â””â”€ proofs: Vec<KZGProof>

åŸå› ï¼š
â”œâ”€ Blob æ•°æ®å¾ˆå¤§ï¼ˆæ¯ä¸ª 128KBï¼‰
â”œâ”€ åªéœ€çŸ­æœŸä¿ç•™ï¼ˆçº¦ 18 å¤©ï¼‰
â””â”€ ä¸å­˜å…¥æ‰§è¡Œå±‚æ•°æ®åº“ï¼ˆä»…å…±è¯†å±‚ä¿ç•™ï¼‰
```

---

### ğŸ“Š **Reth vs Geth æ ¸å¿ƒå·®å¼‚**

**âœ… å‡†ç¡®æ€»ç»“ï¼** è¡¥å……æ›´å¤šç»†èŠ‚ï¼š

| ç»´åº¦ | Reth | Geth |
|------|------|------|
| **State ç®¡ç†** | `BundleState` (å†…å­˜é«˜æ•ˆ) | `JournalDB` (æ›´å¤æ‚çš„æ—¥å¿—) |
| **Trie è®¡ç®—** | å¢é‡æ›´æ–° + PrefixSets | æ¯æ¬¡å¯èƒ½å…¨é‡æˆ–éƒ¨åˆ†é‡ç®— |
| **å­˜å‚¨å¼•æ“** | MDBX + Static Files | LevelDBï¼ˆæ—§ç‰ˆï¼‰/ Pebble |
| **å¹¶è¡Œæ‰§è¡Œ** | Rayon å¹¶è¡Œ storage_root | å•çº¿ç¨‹æ‰§è¡Œ |
| **å†…å­˜ä¼˜åŒ–** | æ˜¾å¼æ§åˆ¶ allocation | ä¾èµ– Go GC |
| **äº¤æ˜“æ± ** | ç®€åŒ–çš„ Vec + ç´¢å¼• | å¤šå±‚å¤æ‚ç´¢å¼•ï¼ˆpending/queuedï¼‰ |
| **ä»£ç è¯­è¨€** | Rustï¼ˆé›¶æˆæœ¬æŠ½è±¡ï¼‰ | Goï¼ˆGC overheadï¼‰ |

---

## ğŸ“ **æ€»ç»“**

ä½ çš„æŠ€æœ¯æ€»ç»“å±•ç°äº†å¯¹ Reth å†…éƒ¨æœºåˆ¶çš„æ·±åˆ»ç†è§£ï¼ç‰¹åˆ«æ˜¯ï¼š

1. âœ… **BundleState æ¡¥æ¥ä½œç”¨**ï¼šå‡†ç¡®æŠ“ä½äº†å†…å­˜çŠ¶æ€åˆ°æŒä¹…åŒ–çš„å…³é”®è·¯å¾„
2. âœ… **å¢é‡ä¼˜åŒ–ç­–ç•¥**ï¼šç†è§£äº† Reth æ€§èƒ½çš„æ ¸å¿ƒä¼˜åŠ¿
3. âœ… **EIP-1559/4844 å…¬å¼**ï¼šæ•°å­¦å»ºæ¨¡å®Œå…¨æ­£ç¡®
4. âœ… **äº¤æ˜“æ‰§è¡Œç»“æœåŒºåˆ†**ï¼šSuccess/Revert/Halt çš„ç»†å¾®å·®åˆ«ç†è§£åˆ°ä½
5. âœ… **å¹¶å‘å®‰å…¨è®¾è®¡**ï¼šå¼‚æ­¥ payload æ„å»ºçš„ä¸¤é˜¶æ®µæ¨¡å‹æ¸…æ™°
6. âœ… **å¸¸è§é™·é˜±è¯†åˆ«**ï¼šWithdrawals/Bloom/Blob çš„ç‰¹æ®Šå¤„ç†éƒ½å‡†ç¡®

è¿™ä»½æ€»ç»“å¯ä»¥ä½œä¸º **Reth æŠ€æœ¯æ‰‹å†Œ**çš„æ ¸å¿ƒå†…å®¹ï¼ğŸš€