# å…±è¯†å±‚ä¸æ‰§è¡Œå±‚äº¤äº’æœºåˆ¶è¯¦è§£

## ğŸ¯ æ ¸å¿ƒç­”æ¡ˆ

### **åŒºå—æ„å»ºæ˜¯è°åšçš„ï¼Ÿ**
**æ‰§è¡Œå±‚ï¼ˆExecution Layerï¼‰è´Ÿè´£æ„å»ºåŒºå—**ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹æ˜¯ç”±**å…±è¯†å±‚ï¼ˆConsensus Layerï¼‰å‘èµ·å’Œåè°ƒ**çš„ã€‚

### **åˆ†å·¥æ˜ç¡®**
```
å…±è¯†å±‚ï¼ˆCLï¼‰- Beacon Chain
â”œâ”€ è´Ÿè´£ï¼šPoS å…±è¯†ã€éªŒè¯è€…é€‰æ‹©ã€æœ€ç»ˆæ€§
â”œâ”€ å†³å®šï¼šä»€ä¹ˆæ—¶å€™å‡ºå—ã€è°æ¥å‡ºå—
â””â”€ åè°ƒï¼šé€šè¿‡ Engine API æŒ‡æŒ¥æ‰§è¡Œå±‚

æ‰§è¡Œå±‚ï¼ˆELï¼‰- Reth/Geth ç­‰
â”œâ”€ è´Ÿè´£ï¼šäº¤æ˜“æ‰§è¡Œã€çŠ¶æ€è½¬æ¢ã€åŒºå—æ„å»º
â”œâ”€ æä¾›ï¼šå·²æ„å»ºçš„åŒºå—ç»™å…±è¯†å±‚
â””â”€ å“åº”ï¼šå…±è¯†å±‚çš„æŒ‡ä»¤ï¼ˆé€šè¿‡ Engine APIï¼‰
```

---

## ğŸ”Œ Engine API - ä¸¤å±‚çš„æ¡¥æ¢

è‡ªä»¥å¤ªåŠ The Mergeï¼ˆParis å‡çº§ï¼‰åï¼Œå…±è¯†å±‚å’Œæ‰§è¡Œå±‚é€šè¿‡ **Engine API** è¿›è¡Œé€šä¿¡ã€‚

### Engine API æ ¸å¿ƒæ–¹æ³•

```rust
// å®šä¹‰åœ¨ crates/rpc/rpc-api/src/engine.rs

pub trait EngineApi {
    // 1ï¸âƒ£ æ¥æ”¶æ–°åŒºå—ï¼ˆéªŒè¯ä»ç½‘ç»œæ”¶åˆ°çš„åŒºå—ï¼‰
    async fn new_payload_v3(
        &self,
        payload: ExecutionPayloadV3,
        versioned_hashes: Vec<B256>,
        parent_beacon_block_root: B256,
    ) -> RpcResult<PayloadStatus>;

    // 2ï¸âƒ£ æ›´æ–°åˆ†å‰é€‰æ‹©ï¼ˆå¯èƒ½è§¦å‘åŒºå—æ„å»ºï¼‰
    async fn fork_choice_updated_v3(
        &self,
        fork_choice_state: ForkchoiceState,
        payload_attributes: Option<PayloadAttributes>,  // â† å…³é”®ï¼
    ) -> RpcResult<ForkchoiceUpdated>;

    // 3ï¸âƒ£ è·å–æ„å»ºå¥½çš„åŒºå—
    async fn get_payload_v3(
        &self,
        payload_id: PayloadId,
    ) -> RpcResult<ExecutionPayloadEnvelopeV3>;
}
```

---

## ğŸ“ å®Œæ•´çš„åŒºå—ç”Ÿäº§æµç¨‹

### åœºæ™¯ï¼šä½ çš„èŠ‚ç‚¹è¢«é€‰ä¸­ä½œä¸ºæè®®è€…ï¼ˆProposerï¼‰

```
æ—¶é—´çº¿ï¼šSlot Nï¼ˆ12 ç§’ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T=0s: å…±è¯†å±‚æ”¶åˆ° Slot N å¼€å§‹çš„é€šçŸ¥                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T=0.5s: å…±è¯†å±‚å†³å®šå¼€å§‹æ„å»ºåŒºå—                              â”‚
â”‚                                                            â”‚
â”‚ å…±è¯†å±‚è°ƒç”¨ï¼šengine_forkchoiceUpdatedV3                     â”‚
â”‚ {                                                          â”‚
â”‚   "forkchoiceState": {                                    â”‚
â”‚     "headBlockHash": "0xabc...",  // å½“å‰é“¾å¤´              â”‚
â”‚     "safeBlockHash": "0xdef...",                          â”‚
â”‚     "finalizedBlockHash": "0x123..."                      â”‚
â”‚   },                                                       â”‚
â”‚   "payloadAttributes": {           // â† å…³é”®ï¼æœ‰è¿™ä¸ªå°±è¦æ„å»º â”‚
â”‚     "timestamp": 1234567890,                              â”‚
â”‚     "prevRandao": "0x456...",                             â”‚
â”‚     "suggestedFeeRecipient": "0x789...",                  â”‚
â”‚     "withdrawals": [...],                                 â”‚
â”‚     "parentBeaconBlockRoot": "0xabc..."                   â”‚
â”‚   }                                                        â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ (é€šè¿‡ HTTP/JSON-RPC)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡Œå±‚ï¼ˆRethï¼‰æ¥æ”¶åˆ°è¯·æ±‚                                    â”‚
â”‚                                                            â”‚
â”‚ å®ç°åœ¨ï¼šcrates/rpc/rpc-engine-api/src/engine_api.rs       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T=0.5s: æ‰§è¡Œå±‚ç«‹å³å“åº”ï¼ˆPhase 1 - åŒæ­¥ï¼‰                   â”‚
â”‚                                                            â”‚
â”‚ 1. éªŒè¯ PayloadAttributes æœ‰æ•ˆæ€§                          â”‚
â”‚ 2. ç”Ÿæˆ payload_id = hash(attributes)                     â”‚
â”‚ 3. ç«‹å³è¿”å›ç»™å…±è¯†å±‚ âœ…                                      â”‚
â”‚                                                            â”‚
â”‚ Response: {                                               â”‚
â”‚   "payloadStatus": {                                      â”‚
â”‚     "status": "VALID",                                    â”‚
â”‚     "latestValidHash": "0xabc..."                         â”‚
â”‚   },                                                       â”‚
â”‚   "payloadId": "0x1234567890abcdef"  // â† æ„å»ºä»»åŠ¡ ID     â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T=0.5s~4s: æ‰§è¡Œå±‚åå°å¼‚æ­¥æ„å»ºï¼ˆPhase 2 - å¼‚æ­¥ï¼‰            â”‚
â”‚                                                            â”‚
â”‚ tokio::spawn(async move {                                 â”‚
â”‚     // åˆ›å»º PayloadJob                                     â”‚
â”‚     let job = generator.new_payload_job(attributes)?;     â”‚
â”‚                                                            â”‚
â”‚     // åå°æŒç»­æ”¹è¿›åŒºå—ï¼ˆè¾¹æ‰§è¡Œè¾¹æ‰“åŒ…ï¼‰                     â”‚
â”‚     loop {                                                 â”‚
â”‚         // ä»äº¤æ˜“æ± è·å–äº¤æ˜“                                â”‚
â”‚         while let Some(tx) = best_txs.next() {            â”‚
â”‚             // æ‰§è¡Œäº¤æ˜“                                    â”‚
â”‚             executor.execute_transaction(tx)?;            â”‚
â”‚                                                            â”‚
â”‚             // æ£€æŸ¥é™åˆ¶æ¡ä»¶                                â”‚
â”‚             if should_stop() { break; }                   â”‚
â”‚         }                                                  â”‚
â”‚                                                            â”‚
â”‚         // è®¡ç®— state_root, receipts_root ç­‰              â”‚
â”‚         let payload = finalize_block()?;                  â”‚
â”‚                                                            â”‚
â”‚         // ç¼“å­˜åˆ° payload_store                            â”‚
â”‚         payload_store.put(payload_id, payload);           â”‚
â”‚     }                                                      â”‚
â”‚ })                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T=4s: å…±è¯†å±‚è¯·æ±‚è·å–æ„å»ºå¥½çš„åŒºå—                             â”‚
â”‚                                                            â”‚
â”‚ å…±è¯†å±‚è°ƒç”¨ï¼šengine_getPayloadV3(payload_id)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡Œå±‚è¿”å›æ„å»ºå¥½çš„åŒºå—                                       â”‚
â”‚                                                            â”‚
â”‚ Response: {                                               â”‚
â”‚   "executionPayload": {                                   â”‚
â”‚     "blockNumber": 12345678,                              â”‚
â”‚     "blockHash": "0xnew...",                              â”‚
â”‚     "parentHash": "0xabc...",                             â”‚
â”‚     "stateRoot": "0xstate...",   // â† å·²è®¡ç®—å®Œæˆ          â”‚
â”‚     "receiptsRoot": "0xrec...",                           â”‚
â”‚     "transactions": [...],        // â† å·²æ‰“åŒ…çš„äº¤æ˜“        â”‚
â”‚     "gasUsed": 15234567,                                  â”‚
â”‚     ...                                                    â”‚
â”‚   },                                                       â”‚
â”‚   "blockValue": "0x123...",      // åŒºå—ä»·å€¼ï¼ˆMEVï¼‰        â”‚
â”‚   "blobsBundle": {...},          // Blob sidecars        â”‚
â”‚   "requests": [...]              // EIP-7002 ç­‰è¯·æ±‚       â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T=4s: å…±è¯†å±‚æ„é€  Beacon Block                               â”‚
â”‚                                                            â”‚
â”‚ BeaconBlock {                                             â”‚
â”‚   slot: N,                                                â”‚
â”‚   proposer_index: 123,                                    â”‚
â”‚   parent_root: "0x...",                                   â”‚
â”‚   state_root: "0x...",  // Beacon çŠ¶æ€æ ¹ï¼ˆä¸æ˜¯ EL çš„ï¼‰     â”‚
â”‚   body: {                                                  â”‚
â”‚     randao_reveal: "0x...",                               â”‚
â”‚     eth1_data: {...},                                     â”‚
â”‚     graffiti: "Reth",                                     â”‚
â”‚     proposer_slashings: [],                               â”‚
â”‚     attester_slashings: [],                               â”‚
â”‚     attestations: [...],                                  â”‚
â”‚     deposits: [],                                         â”‚
â”‚     voluntary_exits: [],                                  â”‚
â”‚     sync_aggregate: {...},                                â”‚
â”‚     execution_payload: <ä» getPayload è·å¾—>  // â† åµŒå…¥è¿™é‡Œ â”‚
â”‚   }                                                        â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ T=4s: å…±è¯†å±‚å¹¿æ’­ Beacon Block åˆ° P2P ç½‘ç»œ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ¥æ”¶åŒºå—çš„æµç¨‹ï¼ˆå¦ä¸€ä¸ªèŠ‚ç‚¹ï¼‰

```
å…¶ä»–éªŒè¯è€…èŠ‚ç‚¹æ”¶åˆ° Beacon Block
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…±è¯†å±‚éªŒè¯ Beacon Block                                     â”‚
â”‚ â”œâ”€ éªŒè¯æè®®è€…ç­¾å                                           â”‚
â”‚ â”œâ”€ éªŒè¯ attestations                                       â”‚
â”‚ â””â”€ æå– execution_payload                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…±è¯†å±‚è°ƒç”¨æ‰§è¡Œå±‚ï¼šengine_newPayloadV3                       â”‚
â”‚                                                            â”‚
â”‚ {                                                          â”‚
â”‚   "executionPayload": <ä» Beacon Block æå–>,              â”‚
â”‚   "versionedHashes": [...],                               â”‚
â”‚   "parentBeaconBlockRoot": "0x..."                        â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡Œå±‚ï¼ˆRethï¼‰éªŒè¯å¹¶æ‰§è¡ŒåŒºå—                                â”‚
â”‚                                                            â”‚
â”‚ å®ç°åœ¨ï¼šcrates/rpc/rpc-engine-api/src/engine_api.rs       â”‚
â”‚                                                            â”‚
â”‚ async fn new_payload_v3(...) {                            â”‚
â”‚     // 1. è½¬æ¢ä¸º SealedBlock                               â”‚
â”‚     let block = convert_to_block(payload)?;               â”‚
â”‚                                                            â”‚
â”‚     // 2. æ£€æŸ¥æ— æ•ˆç¥–å…ˆ                                     â”‚
â”‚     if has_invalid_ancestor(block) {                      â”‚
â”‚         return INVALID;                                    â”‚
â”‚     }                                                      â”‚
â”‚                                                            â”‚
â”‚     // 3. Pre-execution éªŒè¯                               â”‚
â”‚     consensus.validate_block_pre_execution(block)?;       â”‚
â”‚                                                            â”‚
â”‚     // 4. æ‰§è¡Œæ‰€æœ‰äº¤æ˜“                                     â”‚
â”‚     let result = executor.execute_one(block)?;            â”‚
â”‚                                                            â”‚
â”‚     // 5. Post-execution éªŒè¯                              â”‚
â”‚     consensus.validate_block_post_execution(               â”‚
â”‚         block, result, None                               â”‚
â”‚     )?;                                                    â”‚
â”‚                                                            â”‚
â”‚     // 6. è¿”å›ç»“æœ                                         â”‚
â”‚     return VALID;                                          â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡Œå±‚è¿”å›éªŒè¯ç»“æœ                                           â”‚
â”‚                                                            â”‚
â”‚ Response: {                                               â”‚
â”‚   "status": "VALID",                                      â”‚
â”‚   "latestValidHash": "0xnew...",                          â”‚
â”‚   "validationError": null                                 â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…±è¯†å±‚è°ƒç”¨ï¼šengine_forkchoiceUpdatedV3                     â”‚
â”‚                                                            â”‚
â”‚ {                                                          â”‚
â”‚   "forkchoiceState": {                                    â”‚
â”‚     "headBlockHash": "0xnew...",  // â† æ›´æ–°é“¾å¤´            â”‚
â”‚     "safeBlockHash": "0x...",                             â”‚
â”‚     "finalizedBlockHash": "0x..."                         â”‚
â”‚   },                                                       â”‚
â”‚   "payloadAttributes": null       // â† ä¸æ„å»ºæ–°åŒºå—        â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡Œå±‚æ›´æ–°é“¾çŠ¶æ€                                             â”‚
â”‚ â”œâ”€ æ›´æ–° canonical chain å¤´éƒ¨æŒ‡é’ˆ                           â”‚
â”‚ â”œâ”€ è§¦å‘ reorg å¦‚æœéœ€è¦                                     â”‚
â”‚ â””â”€ é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å…³é”®å®ç°ç»†èŠ‚

### 1. Engine API çš„å®ç°ä½ç½®

```
Reth ä»£ç ç»“æ„:
â”œâ”€ crates/rpc/rpc-api/src/engine.rs
â”‚  â””â”€ EngineApi trait å®šä¹‰ï¼ˆæ¥å£ï¼‰
â”‚
â”œâ”€ crates/rpc/rpc-engine-api/src/engine_api.rs
â”‚  â””â”€ EngineApi å®ç°ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
â”‚
â”œâ”€ crates/engine/tree/src/
â”‚  â””â”€ EngineApiTreeHandlerï¼ˆçŠ¶æ€ç®¡ç†ï¼‰
â”‚
â””â”€ crates/payload/builder/src/
   â””â”€ PayloadBuilderServiceï¼ˆåŒºå—æ„å»ºæœåŠ¡ï¼‰
```

### 2. PayloadAttributes çš„å…³é”®æ€§

```rust
// PayloadAttributes çš„å­˜åœ¨å†³å®šæ˜¯å¦æ„å»ºæ–°åŒºå—

// åœºæ™¯ 1: æœ‰ PayloadAttributes â†’ å¼€å§‹æ„å»ºåŒºå—
engine_forkchoiceUpdatedV3(
    forkchoiceState,
    Some(payloadAttributes)  // â† å…±è¯†å±‚è¯´ï¼šè¯·å¸®æˆ‘æ„å»ºåŒºå—
)
â†’ æ‰§è¡Œå±‚åˆ›å»º PayloadJobï¼Œåå°å¼‚æ­¥æ„å»º

// åœºæ™¯ 2: æ—  PayloadAttributes â†’ ä»…æ›´æ–°åˆ†å‰é€‰æ‹©
engine_forkchoiceUpdatedV3(
    forkchoiceState,
    None  // â† å…±è¯†å±‚è¯´ï¼šåªæ˜¯æ›´æ–°é“¾å¤´ï¼Œä¸éœ€è¦æ„å»º
)
â†’ æ‰§è¡Œå±‚åªæ›´æ–°å†…éƒ¨çŠ¶æ€ï¼Œä¸æ„å»ºåŒºå—
```

### 3. ä¸ºä»€ä¹ˆè¦ä¸¤æ­¥èµ°ï¼ˆforkchoiceUpdated + getPayloadï¼‰ï¼Ÿ

```
åŸå› ï¼š
1ï¸âƒ£ éé˜»å¡è®¾è®¡
   â””â”€ forkchoiceUpdated ç«‹å³è¿”å›ï¼ˆ< 1 ç§’ï¼‰
   â””â”€ ä¸ä¼šé˜»å¡å…±è¯†å±‚çš„å…¶ä»–å·¥ä½œ

2ï¸âƒ£ æŒç»­æ”¹è¿›
   â””â”€ æ‰§è¡Œå±‚å¯ä»¥åœ¨åå°æŒç»­ä¼˜åŒ–åŒºå—
   â””â”€ æ·»åŠ æ›´å¤šé«˜ä»·å€¼äº¤æ˜“
   â””â”€ ç›´åˆ°å…±è¯†å±‚è°ƒç”¨ getPayload

3ï¸âƒ£ çµæ´»çš„ deadline
   â””â”€ å…±è¯†å±‚å¯ä»¥åœ¨ä»»ä½•æ—¶å€™è·å–åŒºå—
   â””â”€ é€šå¸¸åœ¨ slot çš„ç¬¬ 4 ç§’è°ƒç”¨
   â””â”€ ä½†å¯ä»¥æå‰æˆ–å»¶å

4ï¸âƒ£ MEV ä¼˜åŒ–
   â””â”€ ç»™ MEV-Boost ç­‰ç³»ç»Ÿæ—¶é—´å¯»æ‰¾æ›´ä¼˜åŒºå—
   â””â”€ å¯ä»¥æ¯”è¾ƒå¤šä¸ªæ„å»ºè€…çš„åŒºå—
```

### 4. é€šä¿¡æ–¹å¼

```
ç‰©ç†è¿æ¥ï¼š
â”œâ”€ HTTP/JSON-RPCï¼ˆä¸»æµï¼‰
â”‚  â”œâ”€ é»˜è®¤ç«¯å£ï¼š8551
â”‚  â”œâ”€ ä½¿ç”¨ JWT è®¤è¯
â”‚  â””â”€ æœ¬åœ°é€šä¿¡ï¼ˆé€šå¸¸æ˜¯ localhostï¼‰
â”‚
â””â”€ IPCï¼ˆå¯é€‰ï¼‰
   â””â”€ Unix Socket æˆ– Named Pipe
```

### 5. JWT è®¤è¯æœºåˆ¶

```
å®‰å…¨æªæ–½ï¼š
1. å…±è¯†å±‚å’Œæ‰§è¡Œå±‚å…±äº«ä¸€ä¸ª JWT secret
   â””â”€ é€šå¸¸ä¿å­˜åœ¨ jwt.hex æ–‡ä»¶ä¸­

2. æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦ JWT token
   â””â”€ é˜²æ­¢æœªæˆæƒè®¿é—®

3. ç¤ºä¾‹é…ç½®ï¼š
   Reth:    --authrpc.jwtsecret /path/to/jwt.hex
   Lighthouse: --execution-jwt /path/to/jwt.hex
```

---

## ğŸ“Š å…³é”®æ—¶é—´çº¿

```
Slot æ—¶é•¿ï¼š12 ç§’
â”œâ”€ T=0s:  Slot å¼€å§‹
â”œâ”€ T=0.5s: forkchoiceUpdatedï¼ˆå¼€å§‹æ„å»ºï¼‰
â”œâ”€ T=0.5s~4s: åå°æŒç»­æ„å»ºæ”¹è¿›åŒºå—
â”œâ”€ T=4s:  getPayloadï¼ˆè·å–åŒºå—ï¼‰
â”œâ”€ T=4s~8s: å…±è¯†å±‚æ‰“åŒ… Beacon Block å¹¶å¹¿æ’­
â””â”€ T=12s: ä¸‹ä¸€ä¸ª Slot å¼€å§‹
```

---

## ğŸ¯ æ€»ç»“

### è°è´Ÿè´£ä»€ä¹ˆï¼Ÿ

| èŒè´£ | è´Ÿè´£æ–¹ | è¯´æ˜ |
|------|--------|------|
| **å†³å®šä½•æ—¶å‡ºå—** | å…±è¯†å±‚ | åŸºäº PoS é€‰æ‹©éªŒè¯è€… |
| **å†³å®šå‡ºå—å†…å®¹** | æ‰§è¡Œå±‚ | é€‰æ‹©äº¤æ˜“ã€æ‰§è¡Œã€è®¡ç®—çŠ¶æ€ |
| **æ„å»ºåŒºå—** | æ‰§è¡Œå±‚ | è¾¹æ‰§è¡Œè¾¹æ‰“åŒ…ï¼Œè¾¾åˆ°é™åˆ¶ååœæ­¢ |
| **æ‰“åŒ… Beacon Block** | å…±è¯†å±‚ | å°† ExecutionPayload åµŒå…¥ |
| **éªŒè¯åŒºå—** | ä¸¤è€…åä½œ | å…±è¯†å±‚éªŒè¯å…±è¯†ï¼Œæ‰§è¡Œå±‚éªŒè¯æ‰§è¡Œ |
| **å¹¿æ’­åŒºå—** | å…±è¯†å±‚ | å¹¿æ’­ Beacon Blockï¼ˆåŒ…å« ExecutionPayloadï¼‰ |

### äº¤äº’æ–¹å¼

- **æ¥å£**: Engine APIï¼ˆJSON-RPCï¼‰
- **é€šä¿¡**: HTTPï¼ˆé»˜è®¤ï¼‰æˆ– IPC
- **è®¤è¯**: JWT Token
- **æ¨¡å¼**: å¼‚æ­¥éé˜»å¡

### æ ¸å¿ƒ API

1. **engine_newPayloadV3** - æ¥æ”¶å¹¶éªŒè¯æ–°åŒºå—
2. **engine_forkchoiceUpdatedV3** - æ›´æ–°åˆ†å‰é€‰æ‹© + è§¦å‘æ„å»º
3. **engine_getPayloadV3** - è·å–æ„å»ºå¥½çš„åŒºå—

### è®¾è®¡å“²å­¦

- âœ… **å…³æ³¨ç‚¹åˆ†ç¦»**: å…±è¯†å±‚ç®¡å…±è¯†ï¼Œæ‰§è¡Œå±‚ç®¡æ‰§è¡Œ
- âœ… **å¼‚æ­¥éé˜»å¡**: ä¸å½±å“å…±è¯†å±‚çš„å…¶ä»–å·¥ä½œ
- âœ… **æŒç»­ä¼˜åŒ–**: åå°æŒç»­æ”¹è¿›åŒºå—è´¨é‡
- âœ… **çµæ´»åä½œ**: é€šè¿‡æ ‡å‡† API è§£è€¦ä¸¤å±‚å®ç°

---

è¿™å°±æ˜¯ä»¥å¤ªåŠ PoS æ—¶ä»£å…±è¯†å±‚å’Œæ‰§è¡Œå±‚çš„å®Œæ•´äº¤äº’æœºåˆ¶ï¼ğŸš€
